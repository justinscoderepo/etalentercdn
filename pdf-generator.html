<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Rendering Worker - eTalenter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background-color: #005a87; }
        .example { background-color: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .code { background-color: #f0f0f0; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        .result { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        img { max-width: 100%; border: 1px solid #ddd; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Browser Rendering Worker - eTalenter</h1>
    <p>This worker uses Cloudflare's Browser Rendering API with Puppeteer for screenshots and PDF generation.</p>
    
    <!-- Screenshot Section -->
    <div class="section">
        <h2>üì∏ Take Screenshot</h2>
        <form id="screenshotForm">
            <div class="form-group">
                <label for="screenshot_url">URL to Screenshot:</label>
                <input type="url" id="screenshot_url" name="url" value="https://example.com" required>
            </div>
            <button type="submit">Take Screenshot</button>
        </form>
        <div id="screenshotResult"></div>
        
        <div class="example">
            <h4>API Endpoint:</h4>
            <div class="code">/screenshot?url=https://example.com</div>
            <p>Screenshots are cached for 24 hours using Cloudflare KV.</p>
        </div>
    </div>
    
    <!-- PDF Generation Section -->
    <div class="section">
        <h2>üìÑ Generate PDF</h2>
        <form id="pdfForm">
            <div class="form-group">
                <label for="pdf_url">URL to Convert:</label>
                <input type="url" id="pdf_url" name="url" value="https://example.com" required>
            </div>
            
            <div class="form-group">
                <label for="filename">Filename:</label>
                <input type="text" id="filename" name="filename" value="document.pdf">
            </div>
            
            <div class="form-group">
                <label for="type">Output Type:</label>
                <select id="type" name="type">
                    <option value="pdf">PDF</option>
                    <option value="png">PNG Image</option>
                    <option value="jpeg">JPEG Image</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="format">Page Format:</label>
                <select id="format" name="format">
                    <option value="A4">A4</option>
                    <option value="A3">A3</option>
                    <option value="Letter">Letter</option>
                    <option value="Legal">Legal</option>
                    <option value="Tabloid">Tabloid</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="orientation">Orientation:</label>
                <select id="orientation" name="orientation">
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="scale">Scale (0.1 - 2.0):</label>
                <input type="number" id="scale" name="scale" value="1" min="0.1" max="2.0" step="0.1">
            </div>
            
            <button type="submit">Generate Document</button>
        </form>
        
        <div class="example">
            <h4>Features:</h4>
            <ul>
                <li>‚úÖ PDF generation with custom formatting</li>
                <li>‚úÖ Screenshot capture (PNG/JPEG)</li>
                <li>‚úÖ KV caching for performance</li>
                <li>‚úÖ Custom margins, scale, orientation</li>
                <li>‚úÖ CSS selector targeting</li>
                <li>‚úÖ Multiple output formats</li>
            </ul>
        </div>
    </div>

    <div class="example">
        <h3>üöÄ Next Steps:</h3>
        <ol>
            <li><strong>Get Cloudflare API Token:</strong> Visit <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank">Cloudflare Dashboard</a></li>
            <li><strong>Create KV Namespaces:</strong>
                <div class="code">
npx wrangler kv namespace create BROWSER_KV_DEMO<br>
npx wrangler kv namespace create BROWSER_KV_DEMO --preview
                </div>
            </li>
            <li><strong>Update wrangler.toml:</strong> Add the KV namespace IDs</li>
            <li><strong>Test locally:</strong> <code>npm run dev</code></li>
            <li><strong>Deploy:</strong> <code>npm run deploy</code></li>
        </ol>
        
        <h4>Test URLs:</h4>
        <ul>
            <li>Screenshot: <code>/screenshot?url=https://example.com</code></li>
            <li>PDF: <code>/generate-pdf?url=https://example.com&format=A4</code></li>
        </ul>
    </div>

    <script>
        // Screenshot functionality
        document.getElementById('screenshotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const url = document.getElementById('screenshot_url').value;
            const resultDiv = document.getElementById('screenshotResult');
            
            resultDiv.innerHTML = '<p>Taking screenshot...</p>';
            
            try {
                const response = await fetch(`/screenshot?url=${encodeURIComponent(url)}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const imgUrl = URL.createObjectURL(blob);
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <p>‚úÖ Screenshot taken successfully!</p>
                            <img src="${imgUrl}" alt="Screenshot" />
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        });

        // PDF generation functionality
        document.getElementById('pdfForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const params = {};
            for (let [key, value] of formData.entries()) {
                params[key] = value;
            }
            
            try {
                const response = await fetch('/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = params.filename || 'document.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.text();
                    alert('Error: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    </script>
</body>
</html>
import{r as P,a as D}from"./mainweb-BGfkfzC7.js";import{t as d,b as xe,p as Ie,r as Ne}from"./httpService-I3DGI0wG.js";window.activeRequests={};window.counts={};window.requests={};window.requestCache={};window.firstTimeRequests={};window.localRequestCache={};window.noGetRequests={};try{let s=sessionStorage.getItem("requestCache"),B=JSON.parse(s);B&&(requestCache=B)}catch{}var Se=window.location.href;sessionStorage.getItem("currenturl")==Se&&(sessionStorage.removeItem("requestCache"),requestCache={});sessionStorage.setItem("currenturl",Se);const Je=(...s)=>{let B=!1;return s.forEach(O=>{(O=="fetching"||O=="started"||O=="waiting")&&(B=!0)}),B},Le=(s,{mandatoryValues:B,mandatoryParams:O,select:R,filter:Q,sort:x,offset:E,limit:Y,noGet:_,doCache:Z,deleteUrl:je,updateUrl:Oe})=>{var re,de,ne,ce,ue,oe,le,fe,he,ge;counts[s]||(counts[s]=0),s.includes("GetParticipants");let[f,ee]=P.useState(Q??{});d("filters",f);let[o,te]=P.useState(x??{sortColumn:"id",sortOrder:"ASC"}),[g,U]=P.useState(E??0),[y,ae]=P.useState(Y??1e3);Z&&(f.isCache=!0);let[J,V]=P.useState(counts[s]),[j,M]=P.useState("fetching"),[L,G]=P.useState(""),[t,I]=P.useState(null),a=T(s,R,f,o,g,y);d("🔯 useBackend for "+a);const n=(e,c,u)=>{c==ee&&d("useBackend for "+a+" trying to setting filters with "+JSON.stringify(u)),Object.keys(activeRequests).length===0?(c==I&&d("useBackend for "+a+" trying to set response",u),c==I&&d("useBackend for "+a+" setting response with ",u),c(u),e=u):(c!=I&&(e=u),c==I&&d("useBackend for "+a+" waiting to set response with ",u),setTimeout(()=>{n(e,c,u)},1e3))},N=async e=>{var S,l,m,k,b,K,W,p,v,z,H;let c=typeof e<"u";if(d("mandatoryParams",O),O){let h=[];if(O.forEach(A=>{f[A]||h.push(A)}),h.length){d("useBackend for "+a+" missing params "+h.join(", "));return}}L!=""&&n(L,G,"");try{if(requests[a]="",firstTimeRequests[a]=!0,activeRequests[a]&&!c){d("useBackend for "+a+" waiting in "+window.location.href);return}activeRequests[a]=!0}catch{delete activeRequests[a]}d("🌐 useBackend calling api "+a+" with filters "+JSON.stringify(f));let u={};e&&(u={takeNew:!0,requestDate:new Date().toISOString()}),noGetRequests[a]=!1;let i={};try{i=await xe(""+s,R,{...f,...u},o,g,y),d("🌐 useBackend for "+a+" got response ",i);try{if(a){let h=JSON.stringify(i.data);requests[a]&&console.error({repeatedCalls:{key:a,res:h}}),requests[a]=h}}catch{d("error in setting request")}if(!(((S=i.data)==null?void 0:S.Results)instanceof Array)&&typeof((l=i.data)==null?void 0:l.Results)=="object"?i.data.data=[(m=i.data)==null?void 0:m.Results]:i.data.data=((k=i.data)==null?void 0:k.Results)&&((K=(b=i.data)==null?void 0:b.Results)==null?void 0:K.map)&&((p=(W=i.data)==null?void 0:W.Results)==null?void 0:p.map((h,A)=>({...h,index:A+1}))),(v=i.data)!=null&&v.error)alert(i.data.error),D.error(i.data.message+", please reload or try again"),n(L,G,i.data.message);else{try{localRequestCache[a]=i.data,d("useBackend for "+a+" setting local cache with ",localRequestCache[a]),Z&&((z=i.data.data)!=null&&z.length)&&(requestCache[a]=i.data,sessionStorage.setItem("requestCache",JSON.stringify(requestCache)))}catch{delete requestCache[a],delete localRequestCache[a],d("requestCache not working"),i={data:{data:[]}}}n(t,I,{data:{...i.data}})}}catch(h){D.error(h.message+", please reload or try again"),n(L,G,h.message),delete requestCache[a],delete localRequestCache[a],i={data:{data:[]}}}return delete activeRequests[a],n(j,M,"finished"),counts[s]=counts[s]+1,n(J,V,counts[s]),[(H=i.data)==null?void 0:H.data]};let $=!1,F="";try{Z&&(d("useBackend for "+a+" localRequestCache",localRequestCache[a]),requestCache[a]&&(F=a,$=!0))}catch{d("requestCache not working")}if(a&&_&&noGetRequests[a]==null&&(noGetRequests[a]=!0),!s)throw new Error("url is required");let se=!1;$&&((de=(re=t==null?void 0:t.data)==null?void 0:re.data)!=null&&de.length||(d("requestCache",requestCache),t={data:{data:requestCache[F].data}},j="finished",counts[s]=counts[s]+1,J=counts[s],d("useBackend for "+a+" got data from cache"),se=!0));let ie=!_;if((noGetRequests[a]==null||noGetRequests[a]==!1)&&(ie=!0),ie&&!se){d("localRequestCache",localRequestCache);let e=s+JSON.stringify({select:R,filters:f,localSort:o,localOffset:g,localLimit:y});firstTimeRequests[e]?activeRequests[e]?d("waiting for "+e+" in "+window.location.href):localRequestCache[e]&&(t={data:{data:localRequestCache[e].data}},j="finished",counts[s]=counts[s]+1,J=counts[s],d("useBackend for "+e+" getting data from local cache",t)):(N(),d("useBackend for "+e+" getting data for the first time"))}else d("useBackend for "+a+" not calling api as noGet is true or cache is restored");let C={rows:null,row:null};return((ce=(ne=t==null?void 0:t.data)==null?void 0:ne.data)!=null&&ce.length||j=="finished")&&((oe=(ue=t==null?void 0:t.data)==null?void 0:ue.data)!=null&&oe.length?(C.rows=(le=t.data)==null?void 0:le.data,(he=(fe=t==null?void 0:t.data)==null?void 0:fe.data)!=null&&he.length&&(C.row=(ge=t.data)==null?void 0:ge.data[0])):C.rows=[]),C.setFilter=async e=>{E=0;let c=!1;return typeof e=="boolean"?(e={},c=!0):e&&Object.keys(e).length&&(c=!0),n(g,U,0),f={...f,...e},n(f,ee,{...f,...Q}),a=T(s,R,f,o,g,y),d("useBackend for "+a+" setting filter with "+JSON.stringify(e)),await N(c)},C.setSort=async e=>(x={...x,...e},n(o,te,{...x,...e}),d("useBackend for "+a+" setting sort with "+JSON.stringify(e)),a=T(s,R,f,o,g,y),await N(!0)),C.setLimit=async e=>(Y=e,E=0,n(y,ae,e),n(g,U,0),d("useBackend for "+a+" setting limit with "+e),a=T(s,R,f,o,g,y),await N(!0)),C.setOffset=async e=>(E=e,n(g,U,e),d("useBackend for "+a+" setting offset with "+e),a=T(s,R,f,o,g,y),await N(!0)),C.setOffsetAndLimit=async(e,c,u,i)=>(E=e,Y=c,x={sortColumn:u,sortOrder:i},y=c,g=e,o=x,n(g,U,e),n(y,ae,c),n(o,te,{sortColumn:u,sortOrder:i}),d("useBackend for "+a+" setting offset with "+e+" and limit with "+c),a=T(s,R,f,o,g,y),await N(!0)),C.setWholeData=e=>{I({...t,rows:{...t.data,rows:e}})},C.updateLocal=e=>{var u,i,S,l,m;let c=(i=(u=t==null?void 0:t.data)==null?void 0:u.data)==null?void 0:i.findIndex(k=>k.id===e.id);if(c>=0&&(e={...t.data.data[c],...e}),(S=t==null?void 0:t.data)!=null&&S.data||(t={data:{data:[]}}),c>=0)t.data.data[c]=e;else{let k=(m=(l=t==null?void 0:t.data)==null?void 0:l.data)!=null&&m.length?t.data.data.length:0;(o==null?void 0:o.sortOrder)=="DESC"?(e.index=1,t.data.data=[e,...t.data.data.map((b,K)=>({...b,index:K+2}))]):(e.index=k+1,t.data.data=[...t.data.data,e])}I({...t}),counts[s]=counts[s]+1,n(J,V,counts[s])},C.update=async(e,c,u)=>{var S,l,m,k,b,K,W,p,v,z,H,h,A,qe,we,ye,Ce,me,ke,Re;let i={...e};delete i.index;try{let r=await Ie(Oe||s,i);if((S=r.data)!=null&&S.Results){if(((m=(l=r==null?void 0:r.data)==null?void 0:l.Results)==null?void 0:m.IsSuccess)==!1&&((b=(k=r==null?void 0:r.data)==null?void 0:k.Results)!=null&&b.Message))return D.error((W=(K=r==null?void 0:r.data)==null?void 0:K.Results)==null?void 0:W.Message),Promise.reject({message:(v=(p=r==null?void 0:r.data)==null?void 0:p.Results)==null?void 0:v.Message});if($){let q=F.split("{")[0];Object.keys(requestCache).forEach(w=>{w.startsWith(q)&&delete requestCache[w]}),sessionStorage.setItem("requestCache",JSON.stringify(requestCache))}if(((z=r.data)==null?void 0:z.Results)instanceof Array&&typeof((H=r.data)==null?void 0:H.Results)=="object"){let q=(A=(h=t==null?void 0:t.data)==null?void 0:h.data)==null?void 0:A.findIndex(w=>w.id===r.data.data.id);if(e.id=r.data.data.id,q>=0&&(e={...t.data.data[q],...e}),(qe=t==null?void 0:t.data)!=null&&qe.Results||(t={data:{data:[]}}),!c){if(q>=0)t.data.data[q]=e;else{let w=(ye=(we=t==null?void 0:t.data)==null?void 0:we.data)!=null&&ye.length?t.data.data.length:0;(o==null?void 0:o.sortOrder)=="DESC"?(e.index=1,t.data.data=[e,...t.data.data.map((X,Be)=>({...X,index:Be+2}))]):(e.index=w+1,t.data.data=[...t.data.data,e])}I({...t}),n(j,M,"finished"),counts[s]=counts[s]+1,n(J,V,counts[s])}}else u=!0,n(j,M,"finished"),counts[s]=counts[s]+1,n(J,V,counts[s]);return u&&(n(j,M,"refreshing"),a=T(s,R,f,o,g,y),await N(!0)),[e,t.data.data,r.data]}else{n(j,M,"finished");let q=(Ce=t==null?void 0:t.data)==null?void 0:Ce.SecurityValidations;if(q)return n(L,G,q.join(`
`)),Promise.reject({message:q.join(`
`)});if((me=r==null?void 0:r.data)!=null&&me.modelState){let w=[];return(ke=r==null?void 0:r.data)==null||ke.modelState.forEach(X=>{w.push(X.Key+": "+X.Value)}),n(L,G,w.join.join(`
`)),Promise.reject({message:w.join(`
`)})}else return Promise.reject({message:r.data.message})}}catch(r){let q=r.response,w=(Re=q==null?void 0:q.data)==null?void 0:Re.SecurityValidations;return w?(n(r,G,w.join(`
`)),Promise.reject({message:w.join(`
`)})):Promise.reject(r)}},C.delete=async(e,c)=>{var i,S;let u={...e};try{let l=await Ne(je||s,u);if(l.data.Results)return await N(!0),[e,t.data.data,l];if(n(j,M,"finished"),(i=l==null?void 0:l.data)!=null&&i.modelState){let m=[];return(S=l==null?void 0:l.data)==null||S.modelState.forEach(k=>{m.push(k.Key+": "+k.Value)}),n(L,G,m.join.join(`
`)),Promise.reject({message:m.join(`
`)})}else return Promise.reject({message:"Something went wrong"})}catch(l){return Promise.reject(l)}},{...C,status:j,counter:J,localSort:o,localOffset:g,localLimit:y,filters:f}};function T(s,B,O,R,Q,x){try{return s+JSON.stringify({select:B,filters:O,localSort:R,localOffset:Q,localLimit:x})}catch{d("error in key generation")}return s}export{Je as i,Le as u};

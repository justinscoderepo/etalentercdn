import{p as W,r as h,u as p,n as Te,j as s,L as Ie}from"./main-D6fL8wl5.js";import{L as Pe}from"./layoutOuter-Cord-Ocz.js";import{P as we}from"./pageHeader-BC079V6D.js";import{L as ye}from"./lazyFunction-CEQZ3rnc.js";const Ne=async(u,x)=>{var b={};if(u.JsonSettings!=null&&u.JsonSettings!=""){var g=JSON.parse(u.JsonSettings);b=g}b.scheduleSettings=x;var v=JSON.stringify(b,null,2);await W("/EventJson/Save",{Select:"EVId,JsonSettings",EVId:u.EVId,JsonSettings:v})};let y={};sessionStorage.getItem("allpreferences")&&(y=JSON.parse(sessionStorage.getItem("allpreferences")));const He=()=>{const[u,x]=h.useState([]),[b,g]=h.useState(!1);let[v,z]=h.useState({}),[je,Ge]=h.useState(4),[ve,Me]=h.useState(1),U=localStorage.getItem("preferences"),f=localStorage.getItem("startTime"),M=localStorage.getItem("startDate"),A=localStorage.getItem("timeGap")||10,[S,$]=h.useState(U?JSON.parse(U):{}),d=new Date;if(M&&(d=new Date(M)),d.setHours(9,0,0,0),f){let t=f.split(":");d.setHours(t[0],t[1].split(" ")[0],0,0)}const{row:D}=p("/EventJson/Get",{select:"EVId,JsonSettings",doCache:!0});let k=D?.JsonSettings,L=k?JSON.parse(k):{},R=L.scheduleSettings?.scheduleListPreferences,_=L.scheduleSettings?.scheduleStartTime,V=L.scheduleSettings?.scheduleStartDate;h.useEffect(()=>{_&&(f=_),V&&(M=V),R&&$(R)},[D]);const{rows:T,status:K}=p("/EventStagesJson/Get",{select:"ESGId,Title,Venue",limit:1e3,offset:0,filter:{status:1},doCache:!0}),{rows:C,status:q}=p("/CompetitionStructureJson/GetReadyToStart",{filter:{ParticipantType:1,status:1},sort:{sortOrder:"ASC",sortColumn:"GroupOrder"},select:"CompetitionStructureId,CompetitionItem,CompetitionItemTitle,GroupGroupName,ParticipantType,ParticipantTypeTitle,MaximumMinutes,MaximumSeconds,Gender,Language,GenderGenderTitle,LanguageLanguageName,CompetitionStructureId,CompetitionItem,ParticipantType,MaximumMinutes,MaximumSeconds",doCache:!0,limit:1e3,offset:0}),{rows:I,status:Q}=p("/CompetitionParticipantsJson/Get",{select:"ParticipantId,IdentityNumber,Competition,Candidate,Team",filter:{ParticipantType:1,status:1},doCache:!0,limit:1e4,offset:0}),{rows:X,status:Y}=p("/UsersRolesPlusUsersJson/Get",{select:"UserId,UserName,UserRoleId,UserRoleId,UserJsonSettings,UserDobString,UserImage,UserMobile,UserPhone,Email,Group,IdentityNumber,CandidateUser,UserJsonSettings",filter:{status:1},doCache:!0,limit:1e4,offset:0}),{rows:Z}=p("/CompetitionParticipantsTeamsJson/Get",{select:"TeamId,TeamName,TeamStrength,TeamMembersList,TeamMembers,TeamStrength,IdentityNumber",filter:{status:1},doCache:!0,limit:1e4,offset:0});let{rows:B,status:ee}=p("/competitionItemsJson/Get",{select:"CompetitionId,Title,Category,CategoryCategoryName",filter:{status:1},limit:1e3,doCache:!0});p("/CompetitionParticipantsTeamMembersJson/Get",{select:"*",limit:1e3,filter:{status:1},doCache:!0});let{rows:P,status:te}=p("/CompetitionScheduleJson/Get",{filter:{CompetitionParticipantType:1,status:1},select:"ScheduledStartTime,Stage,Competition,CompetitionParticipantType,ExpectedTotalTimeInMinutes,Ischeduled,ScheduledEndTime,CompetitionCompetitionItem,CompetitionCompetitionItemTItle,CompetitionCompetitionStructureId,CompetitionMaximumMinutes,CompetitionMaximumSeconds,CompetitionMinimumMinutes,CompetitionMinimumSeconds,CompetitionWarningMinute,CompetitionWarningSecond,Phase,PhaseTitle,StageTitle,Status,Event,EventEventName,Order,CreatedBy,CreatedDate,ModifiedDate,ScheduleId,JsonSettings,EventGlobal,Participants,CompetitionPreviosGapInMinutes,AvoidChangeStage",limit:1e3,doCache:!0,offset:0}),F=[];P?.length&&C?.length&&(P=P.filter(t=>C.some(i=>i.CompetitionStructureId===t.Competition)));let N=Te(K,q,Q,Y,ee,te),j=10,G=70,J=d,ie=72*60/j,E=Array.from(Array(ie),(t,i)=>{const e=i*j;return new Date(J.getTime()+e*60*1e3).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})});h.useEffect(()=>{N||C&&I&&T&&P&&(g(!1),w())},[N]);const w=async()=>{ye(async()=>{if(!b){g(!0);let t=JSON.stringify(S);y[d+"_"+t]&&x(y[d+"_"+t]);let i={};I.forEach(r=>{r.Team==0?i[r.Candidate]=X.find(a=>a.UserRoleId===r.Candidate)?.IdentityNumber??"":i[r.Team]=Z.find(a=>a.TeamId===r.Team)?.IdentityNumber??"",i[r.Candidate]||delete i[r.Candidate]});const e=oe(),o=se();let n=re(o);for(let r of n){const a=ae(r,i),m=ce(a,e);m&&await me(m,a,e)}y[d+"_"+t]=e,sessionStorage.setItem("allpreferences",JSON.stringify(y)),x(e),g(!1)}},2e3)},oe=()=>{const t={};return T.forEach(i=>{t[i.ESGId]=[]}),x(t),t},se=()=>C.filter(t=>!F.some(i=>i.Competition===t.CompetitionStructureId)),ne=(t,i)=>{let e=t.target.value;localStorage.setItem(i,e),z({...v,[i]:e}),setTimeout(()=>{g(!1),w()},1e3)},re=t=>{let i=[...F];return t.length>0&&i.push(...t.map(e=>({CompetitionStructureId:e.CompetitionStructureId,Competition:e.CompetitionStructureId,CompetitionCompetitionItemTitle:e.CompetitionItemTitle,GroupGroupName:e.GroupGroupName,CompetitionParticipantTypeTitle:e.ParticipantTypeTitle,CompetitionMaximumMinutes:e.MaximumMinutes,CompetitionMaximumSeconds:e.MaximumSeconds,CompetitionGenderGenderTitle:e.GenderGenderTitle,CompetitionLanguageLanguageName:e.LanguageLanguageName}))),i},ae=(t,i)=>{const e=C.find(l=>l.CompetitionStructureId===t.Competition),o=B.find(l=>l.CompetitionId===e.CompetitionItem);e?.MaximumMinutes||console.error("Competition Maximum Minutes not found for competition: ",e);const n=parseFloat(e?.MaximumMinutes||20),r=I.filter(l=>l.Competition===t.Competition).length;let m=[8,1,105,107].includes(o.Category);const c=le(n,e,r,m);return{CompetitionStructureId:e.CompetitionStructureId,Title:`${e.ParticipantType==1?"ðŸ•º":"ðŸ‘«"} ${e.GroupGroupName} ${e.CompetitionItemTitle}${e.Gender!=3?" "+e.GenderGenderTitle:""} ${e.Language!=4?" "+e.LanguageLanguageName:""}`,Duration:c,ParticipantsCount:r,MaximumMinutes:n,perTimeLimit:e.MaximumMinutes,isOffStage:m,Logs:[],allParticipants:I.filter(l=>l.Competition===e.CompetitionStructureId).map(l=>l.Candidate>0?l.Candidate:l.Team),Participants:I.filter(l=>l.Competition===e.CompetitionStructureId&&i[l.Candidate>0?l.Candidate:l.Team]).map(l=>i[l.Candidate>0?l.Candidate:l.Team])}},le=(t,i,e,o)=>{const n=parseFloat(A)||10;let r=o?t:t*e+n;return r%10===0?r:r+(10-r%10)},me=async(t,i,e)=>{const o=i.Duration/j*G;e[t.ESGId]||(e[t.ESGId]=[]),o>0&&(e[t.ESGId].push({...i,...t,Height:o}),x({...e}),await new Promise(n=>setTimeout(n,1e3)))};let de=(t,i)=>{let e=S[i];if(!e)return!1;let o=C.find(n=>n.CompetitionStructureId===t.CompetitionStructureId);return e.find(n=>n==o.CompetitionItem)};const ce=(t,i)=>{for(let e=0;e<E.length;e++){const o=e*G,n=t.Duration/j,r=o+G*n,a=fe(E[e]),m=new Date(a);m.setMinutes(m.getMinutes()+t.Duration);for(let c of T){const l=i[c.ESGId]||[];if(!de(t,c.ESGId))continue;let H={StartTime:a,EndTime:m,topPosition:o,bottomPosition:r,stage:c,ESGId:c.ESGId};if(pe(H,l)&&!ue(t,i,H))return{...H}}}return null},ue=(t,i,e)=>{for(let n of T)if(e?.stage?.Title!=n.Title){t.CompetitionStructureId==5622;const r=i[n.ESGId]||[];for(var o of r){let a=!1;if(e.topPosition<o.bottomPosition&&e.bottomPosition>o.topPosition&&(a=!0),e.topPosition>o.bottomPosition&&e.bottomPosition<o.topPosition&&(a=!0),e.topPosition>o.topPosition&&e.topPosition<o.topPosition&&(a=!0),e.bottomPosition>o.topPosition&&e.bottomPosition<o.topPosition&&(a=!0),a){let m=[];for(let c of o.Participants)for(let l of t.Participants)c===l&&m.push(c);if(m.length>0)return t.Logs.push(m.join(", ")+` - ${o.StartTime.toLocaleTimeString()} - ${o.EndTime.toLocaleTimeString()} @ ${o.stage.Title} - ${o.Title}`),!0}}}return!1},pe=(t,i,e)=>{let o=!0;for(let n of i){if(n.topPosition<t.bottomPosition&&n.bottomPosition>t.topPosition||n.topPosition>t.bottomPosition&&n.bottomPosition<t.topPosition||n.topPosition>t.topPosition&&n.topPosition<t.topPosition||n.bottomPosition>t.topPosition&&n.bottomPosition<t.topPosition)return o=!1,o;if(!o)return o}return o},fe=t=>{const i=t.split(":"),e=new Date(d);return e.setHours(i[0],i[1].split(" ")[0],0,0),e},Se=()=>{window.print()},he=(t,i)=>{let e=Array.from(t.target.selectedOptions,a=>a.value),o=S[i]||[],n=o.filter(a=>e.includes(a));o=o.filter(a=>!n.includes(a));let r=e.filter(a=>!n.includes(a));o=[...new Set([...o,...r])],S[i]=o,$({...S}),localStorage.setItem("preferences",JSON.stringify(S)),setTimeout(()=>{O(),w()},1e3)},O=()=>{Ne(D,{scheduleListPreferences:S,scheduleStartTime:d,scheduleStartDate:d})},xe=t=>{let i=t.target.value,e=i.split(":");J.setHours(e[0],e[1].split(" ")[0],0,0),localStorage.setItem("startTime",i),f=i,setTimeout(()=>{O(),w()},1e3)},ge=t=>{const i=new Date(t.target.value);if(i.setHours(9,0,0,0),f){let e=f.split(":");i.setHours(e[0],e[1].split(" ")[0],0,0)}J=i,f=i,localStorage.setItem("startDate",i),setTimeout(()=>{O(),w()},1e3)};let Ce=d.toISOString().split("T")[0];const be=()=>{let t=1;for(let i in u)for(let e of u[i]){let o=e.StartTime,n=e.EndTime,r=e.ESGId,a={ScheduledStartTimeString:o,ScheduledEndTimeString:n,Stage:r,Competition:e.CompetitionStructureId,order:t};t++;let m=P.find(c=>c.Competition===e.CompetitionStructureId);m&&(a.scheduleId=m.ScheduleId),W("/CompetitionScheduleJson/Save",a)}};return s.jsx(Pe,{children:s.jsxs("div",{className:"flex flex-col grow",children:[s.jsx(we,{heading:"Automated Schedule",subHeading:"Generate and manage automated competition schedules",rightChildren:!N&&s.jsxs(s.Fragment,{children:[s.jsxs("button",{className:"inline-flex items-center gap-x-2 rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700",onClick:be,children:[s.jsx("span",{className:"material-symbols-outlined text-sm",children:"save"}),"Save"]}),s.jsxs("button",{className:"inline-flex items-center gap-x-2 rounded-md bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primaryHover",onClick:Se,children:[s.jsx("span",{className:"material-symbols-outlined text-sm",children:"print"}),"Print"]})]})}),N?s.jsx(Ie,{}):s.jsxs("div",{className:"flex justify-between flex-col w-full print-hidden",children:[s.jsxs("div",{className:"flex justify-between  w-full print:hidden",children:[s.jsxs("div",{className:"flex timeline flex-col w-32 bg-surface",children:[s.jsx("label",{htmlFor:"preferredStartDate",className:"block text-sm font-medium text-onSurfaceVariant p-2",children:"Preferred Start Date"}),s.jsx("input",{type:"date",value:Ce,className:"p-2 border-b-2 border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>ge(t)}),s.jsx("input",{type:"time",value:f,className:"p-2 border-b-2 border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>xe(t)}),s.jsx("input",{type:"number",value:A,className:"p-2 border-b-2 border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"timeGap",name:"timeGap",onChange:t=>ne(t,"timeGap")})]}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,i])=>s.jsxs("div",{className:"bg-white p-2 border-b-2 shadow-md relative flex-1 h-full",children:[s.jsxs("h2",{children:[T.find(e=>e.ESGId===parseInt(t))?.Title," Preferences"]}),s.jsx("select",{value:S[t],onChange:e=>he(e,t),multiple:!0,className:"competitionsPrefernces w-full p-2 border-b-2 border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm min-h-96",children:B.map((e,o)=>s.jsx("option",{value:e.CompetitionId,children:e.Title},o))})]},"stage_"+t))})]}),s.jsxs("div",{className:"flex justify-between  w-full",children:[s.jsx("div",{className:"flex timeline flex-col min-w-32 bg-surface",children:E.map((t,i)=>s.jsx("div",{className:"flex items-center border-b-2 text-center bg-white p-2",style:{height:`${G}px`},children:s.jsx("div",{className:"w-20",children:t})},i))}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,i])=>s.jsx("div",{className:"bg-surface border-b-2 shadow-md relative flex-1 h-full",children:s.jsx("div",{className:"flex flex-col ",children:i.map((e,o)=>s.jsx("div",{className:"min-h-6 max-w-full flex-1 flex min-w-72",children:s.jsxs("div",{className:"bg-white absolute border-x-2 border-darkprimary/40 p-2 shadow-sm border-b-2 flex overflow-y-auto justify-between w-full",style:{height:`${e.Height}px`,top:`${e.topPosition}px`},children:[s.jsxs("div",{className:"max-w-[80%] overflow-auto",children:[s.jsx("h3",{className:"text-green-800 font-medium text-xs pb-1 border-b-2 whitespace-nowrap text-ellipsis overflow-hidden",children:e.Title}),s.jsxs("h2",{className:"text-blue-900 font-medium text-sm py-1 border-b-2 whitespace-nowrap ",children:[new Date(e.StartTime).toLocaleTimeString()," - ",new Date(e.EndTime).toLocaleTimeString()]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx("div",{className:"bg-white shadow p-2",children:e.isOffStage?s.jsx("span",{className:"material-symbols-outlined text-2xl text-amber-700",children:"airline_seat_recline_normal"}):s.jsx("span",{className:"material-symbols-outlined text-2xl text-green-600",children:"podium"})}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-yellow-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-yellow-700",children:"settings_accessibility"}),e.ParticipantsCount]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-pink-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-pink-700",children:"hourglass_top"}),e.perTimeLimit??"?"]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-purple-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-purple-700",children:"timer"}),e.Duration,"m"]})]}),s.jsx("div",{children:e.Logs?.map((n,r)=>s.jsx("div",{className:"text-red-600 text-xs",children:n},r))})]}),s.jsx("div",{className:"flex flex-col overflow-y-auto bg-white max-h-full pr-4 text-xs",children:e.Participants?.map((n,r)=>s.jsx("div",{className:"flex items-center p-2 bg-white text-onSurfaceVariant font-medium border-b-2 ",children:s.jsx("div",{children:n})},r))})]},o)},t+"_"+o))})},t))})]})]})]})})};export{He as default};

import{r as C,j as e,m as X,u as _,z as I}from"./main-Drm7RnIU.js";import{L as ee}from"./layoutOuter-DBvV0J7S.js";import{P as te}from"./pageHeader-D06jO5iy.js";import{O as re}from"./OldNewTabLayout-BD5VsoOV.js";import{e as R}from"./navigationUtils-BHg1ijnp.js";import ae from"./formEditor-DVC5VbbS.js";import{F as k}from"./UserGroupIcon-jJEKuPAi.js";import{F as W}from"./UserIcon-BxCKF21S.js";import{F as q}from"./XCircleIcon-hrR6nC5D.js";import{F as z}from"./CheckCircleIcon-DRMHlPGo.js";import{F as se}from"./PencilIcon-BQPzpsRf.js";import{F as ne}from"./TrashIcon-DsRVgh8R.js";import{F as oe}from"./PlusIcon-BoQWDzwu.js";import{F as ie}from"./TableCellsIcon-5VMRGzeb.js";import"./index.esm-CHsF6MNA.js";import"./renderComponents-C5UhnniP.js";import"./validationMessage-3cvp9cSE.js";import"./CheckCircleIcon-CZh1FXG-.js";import"./modalForm-CPFGLnxm.js";import"./dialog-CC3VlXvk.js";import"./keyboard-CE1cTDvf.js";import"./description-DWDYWUNZ.js";import"./use-is-mounted-CveSXBQu.js";import"./XMarkIcon-s6nY89q6.js";function le({title:t,titleId:o,...m},i){return C.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:i,"aria-labelledby":o},m),t?C.createElement("title",{id:o},t):null,C.createElement("path",{fillRule:"evenodd",d:"M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z",clipRule:"evenodd"}))}const V=C.forwardRef(le),de=(t,o)=>{const m=new Date(t);m.setHours(0,0,0,0);const i=new Date(o);i.setHours(0,0,0,0),i.setDate(i.getDate()+1);let x=i.getFullYear()-m.getFullYear(),l=i.getMonth()-m.getMonth(),f=i.getDate()-m.getDate();if(f<0){l--;const u=new Date(i.getFullYear(),i.getMonth(),0);f+=u.getDate()}return l<0&&(x--,l+=12),{years:x,months:l,days:f}},ce=(t,o)=>{const m=new Date(t);m.setHours(0,0,0,0);const i=new Date(o);i.setHours(0,0,0,0),i.setDate(i.getDate()+1);const x=Math.abs(i-m);return Math.ceil(x/(1e3*60*60*24))+1},me=t=>{if(t.years===0&&t.months===0)return`${t.days} ${t.days===1?"day":"days"}`;if(t.years===0)return t.days===0?`${t.months} ${t.months===1?"month":"months"}`:`${t.months} ${t.months===1?"month":"months"}, ${t.days} ${t.days===1?"day":"days"}`;{const o=[];return o.push(`${t.years} ${t.years===1?"year":"years"}`),t.months>0&&o.push(`${t.months} ${t.months===1?"month":"months"}`),t.days>0&&o.push(`${t.days} ${t.days===1?"day":"days"}`),o.join(", ")}},U=t=>{if(!t)return null;const o=t.split("-");return o.length!==3?null:new Date(parseInt(o[2]),parseInt(o[1])-1,parseInt(o[0]))};function ue({formData:t,getValues:o}){const m=t?.BirthDateTo||o?.("BirthDateTo"),i=t?.BirthDateFrom||o?.("BirthDateFrom");if(!m||!i)return null;const x=U(m),l=U(i);if(!x||!l)return null;const f=new Date().getFullYear(),u=new Date(f,l.getMonth(),l.getDate()),g=f-l.getFullYear(),y=f-x.getFullYear(),v=de(x,l),b=ce(x,l),d=v.years===0;return e.jsxs("div",{className:"p-4 bg-surface border border-primary/20 rounded-md",children:[e.jsxs("h4",{className:"text-sm font-semibold text-onSurface mb-3 flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-cyan-600"}),"Calculated Age Group Preview"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Age From (Youngest)"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[g," years"]})]}),e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Age To (Oldest)"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[y," years"]})]}),e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Calculation Date"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[String(u.getDate()).padStart(2,"0"),"-",String(u.getMonth()+1).padStart(2,"0"),"-",f]})]})]}),e.jsx("div",{className:"bg-emerald-50 p-3 rounded border border-emerald-200",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-xs text-emerald-700 font-medium block mb-1",children:"Birth Date Range Span"}),e.jsx("span",{className:"text-sm font-semibold text-emerald-900",children:me(v)})]}),d&&e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-emerald-700 font-medium block mb-1",children:"Total Days"}),e.jsxs("span",{className:"text-sm font-semibold text-emerald-900",children:[b," ",b===1?"day":"days"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-onSurfaceVariant bg-surfaceCard p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"From (Oldest):"})," ",m]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"To (Youngest):"})," ",i]})]})]})]})}const he=[{text:"Any",value:"Any",icon:k},{text:"Individual",value:"Individual",icon:W},{text:"Team",value:"Team",icon:k}],ge=[{text:"No",value:"No",icon:q},{text:"Yes (Multiple age groups)",value:"Yes",icon:z}],H=t=>{const o=String(t.getDate()).padStart(2,"0"),m=String(t.getMonth()+1).padStart(2,"0"),i=t.getFullYear();return`${o}-${m}-${i}`};function pe({editingGroup:t,existingGroups:o=[],onSubmit:m,onCancel:i,open:x}){const l=C.useMemo(()=>{if(o&&o.length>0){const d=o[0];return{day:d.AgeStartDate||1,month:d.AgeStartMonth||1,year:d.AgeStartYear||new Date().getFullYear()}}return{day:1,month:1,year:new Date().getFullYear()}},[o]),f=(d,D,N)=>{if(!d||!D||!N)return{birthDateFrom:"",birthDateTo:""};try{const j=new Date(N.year,N.month-1,N.day),A=new Date(j);A.setFullYear(A.getFullYear()-D),A.setDate(A.getDate()+1);const T=new Date(j);return T.setFullYear(T.getFullYear()-d+1),{birthDateFrom:H(T),birthDateTo:H(A)}}catch(j){return console.error("Error calculating birth dates from ages:",j),{birthDateFrom:"",birthDateTo:""}}},u=C.useMemo(()=>t?{EventGroupId:t.EventGroupId,GroupName:t.GroupName,BirthDateFrom:t.BirthDateFrom||"",BirthDateTo:t.BirthDateTo||"",AgeFrom:t.AgeFrom||"",AgeTo:t.AgeTo||"",ParticipantType:t.parsedSettings.ParticipantType,IsCommon:t.parsedSettings.IsCommon,NoAgeIdPrefix:t.parsedSettings.NoAgeIdPrefix,Order:t.Order,Status:t.Status}:{Status:2,ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No",AgeFrom:"",AgeTo:""},[t]),g=[{name:"GroupName",label:"Group Name",type:"text",placeholder:"e.g., Juniors, Children, Seniors",validate:{required:!0,minLength:2,maxLength:50}},{name:"ParticipantType",label:"Participant Type",type:"toggle",options:he,validate:{required:!0}},{name:"BirthDateTo",label:"Birth Date From (Oldest Eligible)",type:"normalDate",maxDate:new Date,placeholder:"Select the birth date of the oldest eligible participant (earliest date)",validate:{required:!0,toField:"BirthDateFrom"}},{name:"BirthDateFrom",label:"Birth Date To (Youngest Eligible)",type:"normalDate",maxDate:new Date,placeholder:"Select the birth date of the youngest eligible participant (most recent)",validate:{required:!0,fromField:"BirthDateTo"}},{name:"AgeFrom",label:"Age From (Youngest Age)",type:"number",placeholder:"e.g., 5",description:`Ages calculated on ${l.day}/${l.month}/${l.year}`,min:0,max:100,validate:{required:!0,min:0,max:100,lessThanOrEqualTo:"AgeTo"}},{name:"AgeTo",label:"Age To (Oldest Age)",type:"number",placeholder:"e.g., 12",min:0,max:100,validate:{required:!0,min:0,max:100,greaterThanOrEqualTo:"AgeFrom"}},{name:"AgePreview",type:"custom",render:d=>e.jsx(ue,{...d})},{name:"IsCommon",label:"Is Common Group",type:"toggle",options:ge},{name:"NoAgeIdPrefix",label:"No Age-Based ID Prefix",type:"toggle",options:[{text:"No (Use age prefix)",value:"No",icon:q},{text:"Yes (No prefix)",value:"Yes",icon:z}],conditions:[{key:"IsCommon",value:"No"}]}],y=async(d,...D)=>(d.IsCommon==="Yes"&&(d.NoAgeIdPrefix="Yes"),m(d,...D)),v=(d,D,N)=>{const j=parseInt(d)||0,A=parseInt(D.AgeTo)||0,{birthDateFrom:T,birthDateTo:B}=f(j+1,A,l);N("BirthDateFrom",T),N("BirthDateTo",B)},b=(d,D,N)=>{const j=parseInt(d)||0,A=parseInt(D.AgeFrom)||0,{birthDateFrom:T,birthDateTo:B}=f(A,j,l);N("BirthDateFrom",T),N("BirthDateTo",B)};return e.jsx(ae,{title:t?"Edit Age Group":"Add New Age Group",description:t?"Update age group details by modifying age ranges and calculation dates":"Create a new age group by specifying age ranges and calculation dates",row:u,fields:g,onSave:y,onCancel:i,ageFromOnChange:v,ageToOnChange:b})}function xe({gapInfo:t}){return e.jsxs("div",{className:"relative pb-8",children:[e.jsx("span",{className:"absolute left-6 top-4 -ml-px h-full w-0.5 bg-red-300 border-l-2 border-dashed","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex items-start space-x-3",children:[e.jsx("div",{className:"relative flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full bg-red-100 border-2 border-red-400 border-dashed",children:e.jsx("span",{className:"text-xs font-bold text-red-600",children:"GAP"})}),e.jsx("div",{className:"min-w-0 flex-1",children:e.jsxs("div",{className:"rounded-lg border-2 border-red-200 border-dashed bg-red-50 shadow-sm p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-red-700 mb-2",children:"⚠️ Missing Age Range"}),e.jsxs("div",{className:"text-xs text-red-600 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Gap Ages:"})," ",t.missingAges]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date Range:"})," ",t.dateFrom," to ",t.dateTo]}),e.jsx("p",{className:"italic text-red-500 mt-2",children:"Participants born in this range have no age group assigned!"})]})]})})]})]})}function fe({group:t,onEdit:o,onDelete:m,isLast:i}){const x=t.parsedSettings.ParticipantType==="Individual"?"bg-cyan-500":t.parsedSettings.ParticipantType==="Team"?"bg-emerald-500":"bg-indigo-500",l=t.parsedSettings.ParticipantType==="Individual"?"border-cyan-200":t.parsedSettings.ParticipantType==="Team"?"border-emerald-200":"border-indigo-200",f=t.parsedSettings.ParticipantType==="Individual"?"text-cyan-600":t.parsedSettings.ParticipantType==="Team"?"text-emerald-600":"text-indigo-600",g=(()=>{const y=new Date(t.AgeStartYear,t.AgeStartMonth-1,t.AgeStartDate),v=new Date(y);v.setFullYear(v.getFullYear()-t.AgeTo),v.setDate(v.getDate()+1);const b=new Date(y);b.setFullYear(b.getFullYear()-t.AgeFrom+1);const d=D=>{const N=String(D.getDate()).padStart(2,"0"),j=String(D.getMonth()+1).padStart(2,"0"),A=D.getFullYear();return`${N}-${j}-${A}`};return{from:d(v),to:d(b),minYear:v.getFullYear(),maxYear:b.getFullYear()}})();return e.jsxs("div",{className:"relative pb-8",children:[!i&&e.jsx("span",{className:"absolute left-6 top-8 -ml-px h-full w-0.5 bg-border","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex items-start space-x-3",children:[e.jsx("div",{className:`relative flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full ${x} shadow-sm`,children:e.jsxs("span",{className:"text-base font-bold text-white",children:[t.AgeFrom,"-",t.AgeTo]})}),e.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[e.jsxs("div",{className:`rounded-lg border ${l} bg-surfaceCard shadow-sm p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:`text-base font-semibold ${f}`,children:t.GroupName}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o(t),className:"text-onSurfaceVariant hover:text-primary transition-colors",title:"Edit",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>m(t.EventGroupId),className:"text-onSurfaceVariant hover:text-red-600 transition-colors",title:"Delete",children:e.jsx(ne,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-onSurfaceVariant",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-4 w-4 text-onSurfaceVariant"}),e.jsxs("span",{children:["Age on: ",t.AgeStartDate,"/",t.AgeStartMonth,"/",t.AgeStartYear]})]}),t.parsedSettings.IsCommon==="Yes"&&e.jsx("span",{className:"rounded-full bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-800",children:"Common"}),t.Status!==1&&e.jsx("span",{className:"rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800",children:"Inactive"})]}),e.jsxs("div",{className:"mt-2 text-xs text-onSurfaceVariant",children:["Order: ",t.Order]})]}),e.jsx("div",{className:"rounded-md border border-border bg-surfaceCard shadow-sm p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-onSurfaceVariant flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-onSurface mb-1",children:"Birth Date Range (Eligible Participants)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-onSurfaceVariant",children:"From:"}),e.jsx("span",{className:"ml-1 font-medium text-onSurface",children:g.from}),e.jsxs("span",{className:"ml-1 text-onSurfaceVariant",children:["(",g.minYear,")"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-onSurfaceVariant",children:"To:"}),e.jsx("span",{className:"ml-1 font-medium text-onSurface",children:g.to}),e.jsxs("span",{className:"ml-1 text-onSurfaceVariant",children:["(",g.maxYear,")"]})]})]}),e.jsxs("p",{className:"mt-1 text-xs text-onSurfaceVariant italic",children:["Participants born within this date range will be age ",t.AgeFrom,"-",t.AgeTo," on ",t.AgeStartDate,"/",t.AgeStartMonth,"/",t.AgeStartYear]})]})]})})]})]})]})}function ye({groups:t,onEdit:o,onDelete:m,detectGaps:i}){const x=t.filter(u=>u.parsedSettings.ParticipantType==="Individual"||u.parsedSettings.ParticipantType==="Any").sort((u,g)=>(u.Order||0)-(g.Order||0)),l=t.filter(u=>u.parsedSettings.ParticipantType==="Team"||u.parsedSettings.ParticipantType==="Any").sort((u,g)=>(u.Order||0)-(g.Order||0)),f=(u,g,y,v,b)=>{const d=[];return u.forEach((D,N)=>{d.push(e.jsx("li",{children:e.jsx(fe,{group:D,onEdit:o,onDelete:m,isLast:!1})},D.EventGroupId));const j=g.find(A=>A.afterIndex===N);j&&d.push(e.jsx("li",{children:e.jsx(xe,{gapInfo:j})},`gap-${N}`))}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center gap-2 mb-4 pb-2 border-b-2 ${b.border}`,children:[v,e.jsx("h2",{className:`text-base font-semibold ${b.text}`,children:y}),e.jsxs("span",{className:`ml-auto rounded-full ${b.bg} px-2 py-1 text-xs font-medium ${b.badge}`,children:[u.length," groups"]})]}),u.length===0?e.jsxs("p",{className:"text-sm text-gray-500",children:["No ",y.toLowerCase()," defined"]}):e.jsx("div",{className:"flow-root",children:e.jsx("ul",{className:"-mb-8",children:d})})]})};return e.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[x.length>0&&f(x,i(x),"Individual Groups",e.jsx(W,{className:"h-6 w-6 text-cyan-600"}),{border:"border-cyan-300",text:"text-cyan-700",bg:"bg-cyan-100",badge:"text-cyan-800"}),l.length>0&&f(l,i(l),"Team Groups",e.jsx(k,{className:"h-6 w-6 text-emerald-600"}),{border:"border-emerald-300",text:"text-emerald-700",bg:"bg-emerald-100",badge:"text-emerald-800"})]})}function We(){const{eventDetails:t}=X(),[o,m]=C.useState(null),[i,x]=C.useState(!1),{rows:l,update:f,delete:u,status:g}=_("/AgewiseGroupsJson/Get",{filter:{EventCategory:t?.EventCategory},updateUrl:"/AgewiseGroupsJson/Save",deleteUrl:"/AgewiseGroupsJson/Remove",limit:100,sort:{sortOrder:"ASC",sortColumn:"Order"},select:"EventGroupId,GroupName,AgeFrom,AgeTo,AgeStartDate,AgeStartMonth,AgeStartYear,Status,JsonSettings,Order"});console.log("rows",l);const y=C.useMemo(()=>l?l.map(r=>{let c={ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No"};try{r.JsonSettings&&(c=JSON.parse(r.JsonSettings))}catch(S){console.error("Failed to parse JsonSettings:",S)}return{...r,parsedSettings:c}}):[],[l]),v=r=>{const c=n=>{const s=n.parsedSettings.ParticipantType,a=n.parsedSettings.IsCommon==="Yes";return s==="Individual"&&!a?1:s==="Individual"&&a?2:s==="Team"&&!a?3:s==="Team"&&a?4:5};return[...r].sort((n,s)=>{const a=c(n)-c(s);return a!==0?a:(n.AgeFrom||0)-(s.AgeFrom||0)}).map((n,s)=>({...n,correctOrder:s+1}))},b=async(r,c=!1)=>{if(!r||r.length===0)return;const n=v(r).filter(a=>a.Order!==a.correctOrder);if(n.length===0)return;console.log("Auto-fixing incorrect orders for",n.length,"groups:",n.map(a=>({name:a.GroupName,currentOrder:a.Order,newOrder:a.correctOrder})));const s=n.map(a=>f({EventGroupId:a.EventGroupId,Order:a.correctOrder},!0).catch(h=>(console.error(`Failed to auto-update order for group "${a.GroupName}":`,h),null)));try{const h=(await Promise.all(s)).filter(p=>p!==null).length;!c&&h>0&&console.log(`Auto-fixed order for ${h} group(s)`)}catch(a){console.error("Group order auto-fix errors:",a)}},d=async()=>{if(!y||y.length===0){I.error("No groups available to reorder");return}const r=v(y),c=[];if(r.forEach(n=>{n.Order!==n.correctOrder&&c.push({EventGroupId:n.EventGroupId,GroupName:n.GroupName,currentOrder:n.Order,newOrder:n.correctOrder})}),c.length===0){I.success("All groups are already in correct order");return}console.log("Groups needing order update:",c);const S=c.map(n=>f({EventGroupId:n.EventGroupId,Order:n.newOrder}).catch(s=>{throw console.error(`Failed to update order for group "${n.GroupName}":`,s),s}));try{await Promise.all(S),I.success(`Successfully updated order for ${c.length} group(s)`)}catch(n){I.error("Some group orders failed to update. Check console for details."),console.error("Group order update errors:",n)}},D=r=>{const c=[],S=s=>{const a=String(s.getDate()).padStart(2,"0"),h=String(s.getMonth()+1).padStart(2,"0"),p=s.getFullYear();return`${a}-${h}-${p}`},n=r.map(s=>{const a=new Date(s.AgeStartYear,s.AgeStartMonth-1,s.AgeStartDate),h=new Date(a);h.setFullYear(h.getFullYear()-s.AgeTo),h.setDate(h.getDate()+1);const p=new Date(a);return p.setFullYear(p.getFullYear()-s.AgeFrom+1),{...s,minBirthDate:h,maxBirthDate:p,minBirthDateStr:S(h),maxBirthDateStr:S(p)}});for(let s=0;s<n.length-1;s++){const a=n[s],h=n[s+1],p=new Date(h.maxBirthDate);p.setDate(p.getDate()+1);const w=new Date(a.minBirthDate);if(w.setDate(w.getDate()-1),p<=w){const G=new Date(a.AgeStartYear,a.AgeStartMonth-1,a.AgeStartDate),Y=Math.floor((G-w)/(365.25*24*60*60*1e3)),O=Math.ceil((G-p)/(365.25*24*60*60*1e3));c.push({afterIndex:s,missingAges:Y===O?`Age ${Y}`:`Age ${Y}-${O}`,dateFrom:S(p),dateTo:S(w)})}}return c},N=async r=>{try{const[c,S,n]=(r.BirthDateTo||"1-1-2020").split("-"),[s,a,h]=(r.BirthDateFrom||"31-12-2024").split("-"),p=new Date().getFullYear(),w=new Date(p,parseInt(a)-1,parseInt(s)),G=p-parseInt(h),Y=p-parseInt(n),O=new Date(parseInt(n),parseInt(S)-1,parseInt(c)),Z=new Date(parseInt(h),parseInt(a)-1,parseInt(s)),J=y.find(F=>{if(r.EventGroupId&&F.EventGroupId===r.EventGroupId||F.parsedSettings.ParticipantType!==r.ParticipantType||F.parsedSettings.IsCommon!==r.IsCommon)return!1;const P=new Date(F.AgeStartYear-F.AgeTo,F.AgeStartMonth-1,F.AgeStartDate),$=new Date(F.AgeStartYear-F.AgeFrom,F.AgeStartMonth-1,F.AgeStartDate);return O<=$&&Z>=P});if(J){I.error(`Date range overlaps with existing group "${J.GroupName}". Please adjust the dates to avoid overlap within the same Participant Type and Common Group status.`);return}const Q={EventGroupId:r.EventGroupId||0,EventCategory:t?.EventCategory,GroupName:r.GroupName,AgeFrom:G,AgeTo:Y,AgeStartDate:w.getDate(),AgeStartMonth:w.getMonth()+1,AgeStartYear:w.getFullYear(),Status:1,Order:r.Order||(l?.length||0)+1,JsonSettings:JSON.stringify({ParticipantType:r.ParticipantType,IsCommon:r.IsCommon,NoAgeIdPrefix:r.NoAgeIdPrefix}),BirthDateFrom:r.BirthDateFrom,BirthDateTo:r.BirthDateTo},K=await f(Q,!1,!0),[be,De,Ne,E]=K,M=Array.isArray(E)&&E.length>0?E[0]:null;if(M){console.log("Latest data after save:",M);const F=M.map(P=>{let $={ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No"};try{P.JsonSettings&&($=JSON.parse(P.JsonSettings))}catch(L){console.error("Failed to parse JsonSettings:",L)}return{...P,parsedSettings:$}});await b(F,!0)}I.success(o?"Group updated successfully":"Group added successfully"),m(null),x(!1)}catch(c){I.error("Failed to save group"),console.error(c)}},j=async r=>{if(window.confirm("Are you sure you want to delete this age group?"))try{const c=await u({EventGroupId:r}),[S,n,s]=c;setTimeout(async()=>{try{const a=y.filter(h=>h.EventGroupId!==r);a.length>0&&await b(a,!0)}catch(a){console.error("Failed to auto-fix orders after delete:",a)}},1e3),I.success("Group deleted successfully")}catch{I.error("Failed to delete group")}},A=r=>{let c="",S="";if(r.AgeFrom&&r.AgeTo&&r.AgeStartYear&&r.AgeStartMonth&&r.AgeStartDate)try{const s=new Date(r.AgeStartYear,r.AgeStartMonth-1,r.AgeStartDate),a=new Date(s);a.setFullYear(a.getFullYear()-r.AgeTo),a.setDate(a.getDate()+1);const h=w=>{const G=String(w.getDate()).padStart(2,"0"),Y=String(w.getMonth()+1).padStart(2,"0"),O=w.getFullYear();return`${G}-${Y}-${O}`};S=h(a);const p=new Date(s);p.setFullYear(p.getFullYear()-r.AgeFrom+1),c=h(p)}catch(s){console.error("Error calculating birth dates for editing:",s)}const n={...r,BirthDateFrom:r.BirthDateFrom||c,BirthDateTo:r.BirthDateTo||S};m(n),x(!0)},T=()=>{m(null),x(!1)},B=[{title:"New Page",path:R("/SetUp/ManageGroups")},{title:"Old Page",path:R("/SetUp/ManageGroupsOld")},{title:"Old Table View",path:R("/AgewiseGroups/Manage")}];return e.jsx(re,{tabs:B,children:e.jsx(ee,{children:e.jsxs("div",{className:"flex flex-col grow",children:[e.jsx(te,{heading:"Age Groups Setup",subHeading:"Manage participant age categories and groups",rightChildren:e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>x(!i),className:"inline-flex items-center gap-x-2 rounded-lg bg-gradient-to-r from-primary to-darkprimary px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:shadow-lg hover:scale-105 transition-all duration-200",children:[e.jsx(oe,{className:"h-5 w-5"}),i?"Cancel":"Add New Group"]}),e.jsxs("button",{onClick:d,disabled:g==="loading",className:"inline-flex items-center gap-x-2 rounded-lg bg-emerald-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:shadow-lg hover:scale-105 transition-all duration-200 disabled:bg-surfaceVariant disabled:scale-100",children:[e.jsx(ie,{className:"h-5 w-5"}),"Fix Order"]})]})}),i&&e.jsx(pe,{editingGroup:o,existingGroups:y,onSubmit:N,onCancel:T,open:i}),e.jsx("div",{className:"bg-surface border border-primary/20 rounded-xl p-5 mb-6 shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-blue-100 rounded-lg p-2 flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-onSurface mb-1",children:"Quick Guide"}),e.jsx("p",{className:"text-sm text-onSurfaceVariant leading-relaxed mb-2",children:"Organize participants into age-based groups. Groups are automatically ordered by priority (Individual → Team → Any) and age range."}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs text-onSurfaceVariant",children:[e.jsx("li",{children:"Cyan badges represent Individual participants, Emerald for Teams, Indigo for Any type"}),e.jsx("li",{children:"Red dashed gaps indicate missing age ranges between groups"}),e.jsx("li",{children:'Use "Fix Order" button to manually reorder groups when needed'})]})]})]})}),g==="loading"&&e.jsx("div",{className:"text-center py-8 text-onSurfaceVariant",children:"Loading groups..."}),g==="error"&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-red-500",children:"Error loading age groups. Please try refreshing the page."})}),(g==="success"||g==="finished")&&(!l||l.length===0)&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-onSurfaceVariant",children:'No age groups found. Click "Add New Group" to get started.'})}),(g==="success"||g==="finished")&&l&&l.length>0&&e.jsx(ye,{groups:y,onEdit:A,onDelete:j,detectGaps:D}),e.jsx("div",{className:"mt-8 pt-6 border-t border-border",children:e.jsxs("p",{className:"text-xs text-onSurfaceVariant",children:[e.jsx("strong",{className:"text-primary",children:"What's next?"})," ",e.jsx("a",{href:"/SetUp/ManageCompetitionItems",className:"underline hover:text-primary",children:"Add Competition Items"})," ","|"," ",e.jsx("a",{href:"/CompetitionStructure/Tab",className:"underline hover:text-primary",children:"Assign Competitions to Groups"})," ","|"," ",e.jsx("a",{href:"/Coordinator/ManageBulkParticipants",className:"underline hover:text-primary",children:"Add Participants"})]})})]})})})}export{We as default};

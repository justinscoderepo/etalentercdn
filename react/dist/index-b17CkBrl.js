import { j as jsxRuntimeExports, x as useAppContext, r as reactExports, u as useBackend, p as post, z as zt } from "./main-B7w5eCOl.js";
import { L as LayoutOuter } from "./layoutOuter-CBo2V6Zr.js";
import { P as PageHeader } from "./pageHeader-By7QqcaI.js";
import { O as OldNewTabLayout } from "./OldNewTabLayout-g9TCcW0h.js";
import { F as ForwardRef } from "./ChevronUpIcon-D36EJ1s8.js";
import { F as ForwardRef$1 } from "./ChevronDownIcon-DrbBxP_V.js";
import "./navigationUtils-BZC1EMRn.js";
function ManageResults() {
  return /* @__PURE__ */ jsxRuntimeExports.jsx(
    OldNewTabLayout,
    {
      oldUrl: "/Coordinator/Results",
      newComponent: /* @__PURE__ */ jsxRuntimeExports.jsx(ManageResultsContent, {}),
      title: "Competition Results Management"
    }
  );
}
function ManageResultsContent() {
  const { eventDetails } = useAppContext();
  const [selectedCompetition, setSelectedCompetition] = reactExports.useState(null);
  const [competitionStatus, setCompetitionStatus] = reactExports.useState(null);
  const [expandedScores, setExpandedScores] = reactExports.useState({});
  const { rows: competitions = [] } = useBackend("/CompetitionStructureJson/Get", {
    filter: `EventCategory=${eventDetails?.EventCategoryId || 0}`,
    select: "CompetitionStructureId,Order,GroupGroupName,CompetitionItemTitle,GenderGenderTitle,LanguageLanguageName,ParticipantTypeTitle,CompetitionStatus,CompetitionStatusCompetitionStatusTitle",
    sort: "Order asc"
  });
  const { rows: results = [], refetch } = useBackend("/JudgesScoreCardResultReportJson/Get", {
    filter: selectedCompetition ? `ParticipantCompetition=${selectedCompetition}` : "",
    select: "Participant,CandidateIdentityNumber,TeamIdentityNumber,CandidateUserName,TeamTeamName,IdentityNumber,Score,JudgesCount,ScorecardIdRankTitle,ScorecardIdRank,ScorecardIdResultId,CalculatedScore,AutoIncreasePoints,BonusPoints,ProblematicJudge",
    sort: "Score desc",
    noGet: !selectedCompetition
  });
  const { rows: ranks = [] } = useBackend("/RankPositionsJson/Get", {
    select: "RankId,Title",
    sort: "BonusPoints desc"
  });
  const { rows: statuses = [] } = useBackend("/CompetitionStatusJson/Get", {
    select: "CompetitionStatusId,CompetitionStatusTitle"
  });
  reactExports.useEffect(() => {
    if (selectedCompetition && competitions.length > 0) {
      const comp = competitions.find((c) => c.CompetitionStructureId === selectedCompetition);
      if (comp) {
        setCompetitionStatus(comp.CompetitionStatus);
      }
    }
  }, [selectedCompetition, competitions]);
  const handleCompetitionChange = (competitionId) => {
    setSelectedCompetition(parseInt(competitionId));
    setExpandedScores({});
  };
  const handleRankChange = async (participant, rankId) => {
    const result = results.find((r) => r.Participant === participant);
    if (!result) return;
    try {
      await post("/CoordinatorJson/SaveResultReport", {
        Competition: selectedCompetition,
        Participant: participant,
        Rank: rankId,
        ResultId: result.ScorecardIdResultId,
        Status: 1,
        Remarks: "Updated via Results Management",
        AutoGenerated: 0
      });
      zt.success("Rank updated successfully");
      refetch();
    } catch (error) {
      zt.error("Failed to update rank");
    }
  };
  const handleStatusChange = async (newStatus) => {
    if (!selectedCompetition) return;
    try {
      await post("/CompetitionStructureJson/Save", {
        CompetitionStructureId: selectedCompetition,
        CompetitionStatus: newStatus
      });
      setCompetitionStatus(newStatus);
      zt.success("Competition status updated");
    } catch (error) {
      zt.error("Failed to update status");
    }
  };
  const autoGenerateRanks = async (maxRanks = 2) => {
    if (!results.length || !ranks.length) {
      zt.error("No results or ranks available");
      return;
    }
    const sortedResults = [...results].sort((a, b) => b.Score - a.Score);
    let currentRankIndex = 0;
    let previousScore = null;
    let participantsAtCurrentRank = 0;
    for (let i = 0; i < sortedResults.length && currentRankIndex < maxRanks; i++) {
      const result = sortedResults[i];
      if (previousScore === null || result.Score < previousScore) {
        currentRankIndex += participantsAtCurrentRank;
        if (currentRankIndex >= maxRanks) break;
        participantsAtCurrentRank = 1;
        previousScore = result.Score;
      } else {
        participantsAtCurrentRank++;
      }
      if (currentRankIndex < ranks.length) {
        const rankId = ranks[currentRankIndex].RankId;
        await handleRankChange(result.Participant, rankId);
        await new Promise((resolve) => setTimeout(resolve, 100));
      }
    }
    await handleStatusChange(1);
    zt.success(`Auto-generated top ${maxRanks} ranks successfully`);
  };
  const toggleScoreDetails = (participantId) => {
    setExpandedScores((prev) => ({
      ...prev,
      [participantId]: !prev[participantId]
    }));
  };
  const getCompetitionDisplay = (comp) => {
    const parts = [
      comp.Order,
      "-",
      comp.GroupGroupName,
      comp.CompetitionItemTitle
    ];
    if (comp.GenderGenderTitle && comp.GenderGenderTitle !== "Both") {
      parts.push(comp.GenderGenderTitle);
    }
    if (comp.LanguageLanguageName && comp.LanguageLanguageName !== "Any") {
      parts.push(comp.LanguageLanguageName);
    }
    parts.push(`(${comp.ParticipantTypeTitle})`);
    parts.push(`- ${comp.CompetitionStatusCompetitionStatusTitle || "Not Started"}`);
    return parts.join(" ");
  };
  const isPublished = competitionStatus === 1;
  const isOnReview = competitionStatus === 2 || competitionStatus === 6;
  return /* @__PURE__ */ jsxRuntimeExports.jsxs(LayoutOuter, { children: [
    /* @__PURE__ */ jsxRuntimeExports.jsx(
      PageHeader,
      {
        title: `Manage Results - ${eventDetails?.EventName || ""}`,
        description: "Manage competition results, assign ranks, and publish results"
      }
    ),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "space-y-6", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "bg-white p-6 rounded-lg border border-gray-200 shadow-sm", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-4", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "md:col-span-1", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("label", { className: "block text-sm font-medium text-gray-900 mb-1", children: "Competition *" }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs(
            "select",
            {
              value: selectedCompetition || "",
              onChange: (e) => handleCompetitionChange(e.target.value),
              className: "pl-3 block w-full rounded-md border-0 py-1.5 ring-1 ring-inset focus:ring-2 focus:ring-inset text-sm leading-6 text-gray-900 focus:border-darkprimary ring-gray-300",
              children: [
                /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: "", children: "Select Competition" }),
                competitions.map((comp) => /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: comp.CompetitionStructureId, children: getCompetitionDisplay(comp) }, comp.CompetitionStructureId))
              ]
            }
          )
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("label", { className: "block text-sm font-medium text-gray-900 mb-1", children: "Change Status" }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs(
            "select",
            {
              value: competitionStatus || "",
              onChange: (e) => handleStatusChange(parseInt(e.target.value)),
              disabled: !selectedCompetition,
              className: "pl-3 block w-full rounded-md border-0 py-1.5 ring-1 ring-inset focus:ring-2 focus:ring-inset text-sm leading-6 text-onSurface focus:border-darkprimary ring-border disabled:bg-surface",
              children: [
                /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: "", children: "Select Status" }),
                statuses.map((status) => /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: status.CompetitionStatusId, children: status.CompetitionStatusTitle }, status.CompetitionStatusId))
              ]
            }
          )
        ] }),
        isOnReview && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "flex items-end gap-x-2", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx(
            "button",
            {
              onClick: () => autoGenerateRanks(2),
              className: "inline-flex items-center gap-x-2 rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700",
              children: "Generate Rank 1 & 2"
            }
          ),
          /* @__PURE__ */ jsxRuntimeExports.jsx(
            "button",
            {
              onClick: () => autoGenerateRanks(3),
              className: "inline-flex items-center gap-x-2 rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700",
              children: "Generate Rank 1 - 3"
            }
          )
        ] })
      ] }) }),
      selectedCompetition && /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden", children: results.length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "text-center py-12 bg-surface", children: /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "text-sm text-gray-600", children: "No results available for this competition yet." }) }) : /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "overflow-x-auto", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("table", { className: "min-w-full divide-y divide-gray-200", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("thead", { className: "bg-surface", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("tr", { children: [
          isPublished && /* @__PURE__ */ jsxRuntimeExports.jsx("th", { className: "px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase", children: "Rank" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("th", { className: "px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase", children: "Participant" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("th", { className: "px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase", children: "ID Number" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("th", { className: "px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase", children: "Score Details" }),
          isOnReview && /* @__PURE__ */ jsxRuntimeExports.jsx("th", { className: "px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase", children: "Assign Rank" })
        ] }) }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("tbody", { className: "bg-white divide-y divide-gray-200", children: results.map((result) => /* @__PURE__ */ jsxRuntimeExports.jsxs("tr", { className: "hover:bg-surface", children: [
          isPublished && /* @__PURE__ */ jsxRuntimeExports.jsx("td", { className: "px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900", children: result.ScorecardIdRankTitle || "-" }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("td", { className: "px-4 py-3 text-sm text-gray-900", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "font-mono text-primary", children: result.CandidateIdentityNumber || result.TeamIdentityNumber }),
            " - ",
            result.CandidateUserName || result.TeamTeamName
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("td", { className: "px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-600", children: result.IdentityNumber }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("td", { className: "px-4 py-3 text-sm", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "flex items-center gap-x-2", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsxs(
                "button",
                {
                  onClick: () => toggleScoreDetails(result.Participant),
                  className: "inline-flex items-center gap-x-1 text-primary hover:text-primaryHover font-medium",
                  children: [
                    /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "text-base", children: result.Score }),
                    expandedScores[result.Participant] ? /* @__PURE__ */ jsxRuntimeExports.jsx(ForwardRef, { className: "h-4 w-4" }) : /* @__PURE__ */ jsxRuntimeExports.jsx(ForwardRef$1, { className: "h-4 w-4" })
                  ]
                }
              ),
              /* @__PURE__ */ jsxRuntimeExports.jsxs("span", { className: "text-gray-600 text-xs", children: [
                "(",
                result.JudgesCount,
                " Judge",
                result.JudgesCount !== 1 ? "s" : "",
                ")"
              ] }),
              result.ProblematicJudge && /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "text-red-600 text-xs", title: result.ProblematicJudge, children: "âš " })
            ] }),
            expandedScores[result.Participant] && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "mt-2 p-2 bg-surface rounded text-xs space-y-1", children: [
              result.AutoIncreasePoints > 0 && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
                "TieBreak Score = ",
                result.AutoIncreasePoints
              ] }),
              result.CalculatedScore > 0 && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
                "Total Calculated Points = ",
                result.CalculatedScore
              ] }),
              result.Score > 0 && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
                "Total Actual Points = ",
                result.Score
              ] }),
              result.BonusPoints > 0 && /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
                "Total Bonus Points = ",
                result.BonusPoints
              ] })
            ] })
          ] }),
          isOnReview && /* @__PURE__ */ jsxRuntimeExports.jsx("td", { className: "px-4 py-3 whitespace-nowrap", children: /* @__PURE__ */ jsxRuntimeExports.jsxs(
            "select",
            {
              value: result.ScorecardIdRank || "",
              onChange: (e) => handleRankChange(result.Participant, parseInt(e.target.value)),
              className: "pl-3 block w-full rounded-md border-0 py-1.5 ring-1 ring-inset focus:ring-2 focus:ring-inset text-sm leading-6 text-gray-900 focus:border-darkprimary ring-gray-300",
              children: [
                /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: "", children: "Select Rank" }),
                ranks.map((rank) => /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: rank.RankId, children: rank.Title }, rank.RankId))
              ]
            }
          ) })
        ] }, result.Participant)) })
      ] }) }) })
    ] })
  ] });
}
export {
  ManageResults as default
};

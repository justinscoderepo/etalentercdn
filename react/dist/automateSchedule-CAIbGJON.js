import{r as y,j as s,L as be}from"./mainweb-CyT4_DCY.js";import{B as Te}from"./box-DLH01Mh2.js";import{u as p,i as Ie}from"./useBackend-DeM8wbzk.js";import{p as F}from"./httpService-o7fg2Wgi.js";import{L as Pe}from"./lazyFunction-CEQZ3rnc.js";import"./utilities-CN4lTu6a.js";import"./index-BtuGy7By.js";const ye=async(u,g)=>{var C={};if(u.JsonSettings!=null&&u.JsonSettings!=""){var b=JSON.parse(u.JsonSettings);C=b}C.scheduleSettings=g;var N=JSON.stringify(C,null,2);await F("/EventJson/Save",{Select:"EVId,JsonSettings",EVId:u.EVId,JsonSettings:N})};let w={};sessionStorage.getItem("allpreferences")&&(w=JSON.parse(sessionStorage.getItem("allpreferences")));const Ee=()=>{var V,W,z;const[u,g]=y.useState([]),[C,b]=y.useState(!1);let N=localStorage.getItem("preferences"),f=localStorage.getItem("startTime"),D=localStorage.getItem("startDate"),[S,A]=y.useState(N?JSON.parse(N):{}),c=new Date;if(D&&(c=new Date(D)),c.setHours(9,0,0,0),f){let t=f.split(":");c.setHours(t[0],t[1].split(" ")[0],0,0)}const{row:T}=p("/EventJson/Get",{select:"EVId,JsonSettings",doCache:!0});let $=T==null?void 0:T.JsonSettings,J=$?JSON.parse($):{},R=(V=J.scheduleSettings)==null?void 0:V.scheduleListPreferences,_=(W=J.scheduleSettings)==null?void 0:W.scheduleStartTime,k=(z=J.scheduleSettings)==null?void 0:z.scheduleStartDate;y.useEffect(()=>{_&&(f=_),k&&(D=k),R&&A(R)},[T]);const{rows:I,status:K}=p("/EventStagesJson/Get",{select:"ESGId,Title,Venue",limit:1e3,offset:0,filter:{status:1},doCache:!0}),{rows:h,status:q}=p("/CompetitionStructureJson/GetReadyToStart",{filter:{ParticipantType:1,status:1},sort:{sortOrder:"ASC",sortColumn:"GroupOrder"},select:"CompetitionStructureId,CompetitionItem,CompetitionItemTitle,GroupGroupName,ParticipantType,ParticipantTypeTitle,MaximumMinutes,MaximumSeconds,Gender,Language,GenderGenderTitle,LanguageLanguageName,CompetitionStructureId,CompetitionItem,ParticipantType,MaximumMinutes,MaximumSeconds",doCache:!0,limit:1e3,offset:0}),{rows:j,status:Q}=p("/CompetitionParticipantsJson/Get",{select:"ParticipantId,IdentityNumber,Competition,Candidate,Team",filter:{ParticipantType:1,status:1},doCache:!0,limit:1e4,offset:0}),{rows:X,status:Y}=p("/UsersRolesPlusUsersJson/Get",{select:"UserId,UserName,UserRoleId,UserRoleId,UserJsonSettings,UserDobString,UserImage,UserMobile,UserPhone,Email,Group,IdentityNumber,CandidateUser,UserJsonSettings",filter:{status:1},doCache:!0,limit:1e4,offset:0}),{rows:Z}=p("/CompetitionParticipantsTeamsJson/Get",{select:"TeamId,TeamName,TeamStrength,TeamMembersList,TeamMembers,TeamStrength,IdentityNumber",filter:{status:1},doCache:!0,limit:1e4,offset:0});let{rows:H,status:ee}=p("/competitionItemsJson/Get",{select:"CompetitionId,Title,Category,CategoryCategoryName",filter:{status:1},limit:1e3,doCache:!0});p("/CompetitionParticipantsTeamMembersJson/Get",{select:"*",limit:1e3,filter:{status:1},doCache:!0});let{rows:x,status:te}=p("/CompetitionScheduleJson/Get",{filter:{CompetitionParticipantType:1,status:1},select:"ScheduledStartTime,Stage,Competition,CompetitionParticipantType,ExpectedTotalTimeInMinutes,Ischeduled,ScheduledEndTime,CompetitionCompetitionItem,CompetitionCompetitionItemTItle,CompetitionCompetitionStructureId,CompetitionMaximumMinutes,CompetitionMaximumSeconds,CompetitionMinimumMinutes,CompetitionMinimumSeconds,CompetitionWarningMinute,CompetitionWarningSecond,Phase,PhaseTitle,StageTitle,Status,Event,EventEventName,Order,CreatedBy,CreatedDate,ModifiedDate,ScheduleId,JsonSettings,EventGlobal,Participants,CompetitionPreviosGapInMinutes,AvoidChangeStage",limit:1e3,doCache:!0,offset:0}),B=[];x!=null&&x.length&&(h!=null&&h.length)&&(x=x.filter(t=>h.some(o=>o.CompetitionStructureId===t.Competition)));let E=Ie(K,q,Q,Y,ee,te),G=10,v=70,L=c,ie=72*60/G,O=Array.from(Array(ie),(t,o)=>{const e=o*G;return new Date(L.getTime()+e*60*1e3).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})});y.useEffect(()=>{E||h&&j&&I&&x&&(b(!1),M())},[E]);const M=async()=>{Pe(async()=>{if(!C){b(!0);let t=JSON.stringify(S);if(w[c+"_"+t]){g(w[c+"_"+t]);return}let o={};j.forEach(r=>{var a,l;r.Team==0?o[r.Candidate]=((a=X.find(d=>d.UserRoleId===r.Candidate))==null?void 0:a.IdentityNumber)??"":o[r.Team]=((l=Z.find(d=>d.TeamId===r.Team))==null?void 0:l.IdentityNumber)??"",o[r.Candidate]||delete o[r.Candidate]});const e=oe(),i=se();let n=ne(i);for(let r of n){const a=re(r,o),l=de(a,e);l&&await le(l,a,e)}w[c+"_"+t]=e,sessionStorage.setItem("allpreferences",JSON.stringify(w)),g(e),b(!1)}},2e3)},oe=()=>{const t={};return I.forEach(o=>{t[o.ESGId]=[]}),g(t),t},se=()=>h.filter(t=>!B.some(o=>o.Competition===t.CompetitionStructureId)),ne=t=>{let o=[...B];return t.length>0&&o.push(...t.map(e=>({CompetitionStructureId:e.CompetitionStructureId,Competition:e.CompetitionStructureId,CompetitionCompetitionItemTitle:e.CompetitionItemTitle,GroupGroupName:e.GroupGroupName,CompetitionParticipantTypeTitle:e.ParticipantTypeTitle,CompetitionMaximumMinutes:e.MaximumMinutes,CompetitionMaximumSeconds:e.MaximumSeconds,CompetitionGenderGenderTitle:e.GenderGenderTitle,CompetitionLanguageLanguageName:e.LanguageLanguageName}))),o},re=(t,o)=>{const e=h.find(m=>m.CompetitionStructureId===t.Competition),i=H.find(m=>m.CompetitionId===e.CompetitionItem),n=parseFloat((e==null?void 0:e.MaximumMinutes)||20),r=j.filter(m=>m.Competition===t.Competition).length;let l=[8,1,105,107].includes(i.Category);const d=ae(n,e,r,l);return{CompetitionStructureId:e.CompetitionStructureId,Title:`${e.ParticipantType==1?"ðŸ•º":"ðŸ‘«"} ${e.GroupGroupName} ${e.CompetitionItemTitle}${e.Gender!=3?" "+e.GenderGenderTitle:""} ${e.Language!=4?" "+e.LanguageLanguageName:""}`,Duration:d,ParticipantsCount:r,MaximumMinutes:n,isOffStage:l,Logs:[],Participants:j.filter(m=>m.Competition===e.CompetitionStructureId&&o[m.Candidate>0?m.Candidate:m.Team]).map(m=>o[m.Candidate>0?m.Candidate:m.Team])}},ae=(t,o,e,i)=>{let r=i?t:t*e+0;return r%10===0?r:r+(10-r%10)},le=async(t,o,e)=>{const i=o.Duration/G*v;e[t.ESGId]||(e[t.ESGId]=[]),i>0&&(e[t.ESGId].push({...o,...t,Height:i}),g({...e}),await new Promise(n=>setTimeout(n,1e3)))};let me=(t,o)=>{let e=S[o];if(!e)return!1;let i=h.find(n=>n.CompetitionStructureId===t.CompetitionStructureId);return e.find(n=>n==i.CompetitionItem)};const de=(t,o)=>{for(let e=0;e<O.length;e++){const i=e*v,n=t.Duration/G,r=i+v*n,a=pe(O[e]),l=new Date(a);l.setMinutes(l.getMinutes()+t.Duration);for(let d of I){const m=o[d.ESGId]||[];if(!me(t,d.ESGId))continue;let P={StartTime:a,EndTime:l,topPosition:i,bottomPosition:r,stage:d,ESGId:d.ESGId};if(ue(P,m)&&!ce(t,o,P))return{...P}}}return null},ce=(t,o,e)=>{var n;for(let r of I)if(((n=e==null?void 0:e.stage)==null?void 0:n.Title)!=r.Title){t.CompetitionStructureId==5622;const a=o[r.ESGId]||[];for(var i of a){let l=!1;if(e.topPosition<i.bottomPosition&&e.bottomPosition>i.topPosition&&(l=!0),e.topPosition>i.bottomPosition&&e.bottomPosition<i.topPosition&&(l=!0),e.topPosition>i.topPosition&&e.topPosition<i.topPosition&&(l=!0),e.bottomPosition>i.topPosition&&e.bottomPosition<i.topPosition&&(l=!0),l){let d=[];for(let m of i.Participants)for(let P of t.Participants)m===P&&d.push(m);if(d.length>0)return t.Logs.push(d.join(", ")+` - ${i.StartTime.toLocaleTimeString()} - ${i.EndTime.toLocaleTimeString()} @ ${i.stage.Title} - ${i.Title}`),!0}}}return!1},ue=(t,o,e)=>{let i=!0;for(let n of o){if(n.topPosition<t.bottomPosition&&n.bottomPosition>t.topPosition||n.topPosition>t.bottomPosition&&n.bottomPosition<t.topPosition||n.topPosition>t.topPosition&&n.topPosition<t.topPosition||n.bottomPosition>t.topPosition&&n.bottomPosition<t.topPosition)return i=!1,i;if(!i)return i}return i},pe=t=>{const o=t.split(":"),e=new Date(c);return e.setHours(o[0],o[1].split(" ")[0],0,0),e},fe=()=>{window.print()},Se=(t,o)=>{let e=Array.from(t.target.selectedOptions,a=>a.value),i=S[o]||[],n=i.filter(a=>e.includes(a));i=i.filter(a=>!n.includes(a));let r=e.filter(a=>!n.includes(a));i=[...new Set([...i,...r])],S[o]=i,A({...S}),localStorage.setItem("preferences",JSON.stringify(S)),setTimeout(()=>{U(),M()},1e3)},U=()=>{ye(T,{scheduleListPreferences:S,scheduleStartTime:c,scheduleStartDate:c})},he=t=>{let o=t.target.value,e=o.split(":");L.setHours(e[0],e[1].split(" ")[0],0,0),localStorage.setItem("startTime",o),f=o,setTimeout(()=>{U(),M()},1e3)},xe=t=>{const o=new Date(t.target.value);if(o.setHours(9,0,0,0),f){let e=f.split(":");o.setHours(e[0],e[1].split(" ")[0],0,0)}L=o,f=o,localStorage.setItem("startDate",o),setTimeout(()=>{U(),M()},1e3)};let ge=c.toISOString().split("T")[0];const Ce=()=>{let t=1;for(let o in u)for(let e of u[o]){let i=e.StartTime,n=e.EndTime,r=e.ESGId,a={ScheduledStartTimeString:i,ScheduledEndTimeString:n,Stage:r,Competition:e.CompetitionStructureId,order:t};t++;let l=x.find(d=>d.Competition===e.CompetitionStructureId);l&&(a.scheduleId=l.ScheduleId),F("/CompetitionScheduleJson/Save",a)}};return s.jsx(Te,{heading:"Automated Schedule",children:E?s.jsx(be,{}):s.jsxs("div",{className:"flex justify-between flex-col w-full print-hidden",children:[s.jsxs("div",{className:"flex justify-end",children:[s.jsx("button",{className:"bg-green-800 px-2 text-white rounded-md",onClick:Ce,children:s.jsx("span",{className:"material-symbols-outlined text-xs text-white",children:"save"})}),s.jsx("button",{className:"bg-blue-800 px-2 text-white rounded-md",onClick:fe,children:s.jsx("span",{className:"material-symbols-outlined text-xs text-white",children:"print"})})]}),s.jsxs("div",{className:"flex justify-between  w-full print:hidden",children:[s.jsxs("div",{className:"flex timeline flex-col w-32 bg-gray-100",children:[s.jsx("label",{htmlFor:"preferredStartDate",className:"block text-sm font-medium text-gray-700 p-2",children:"Preferred Start Date"}),s.jsx("input",{type:"date",value:ge,className:"p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>xe(t)}),s.jsx("input",{type:"time",value:f,className:"p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>he(t)})]}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,o])=>{var e;return s.jsxs("div",{className:"bg-white p-2 border-b-2 shadow-md relative flex-1 h-full",children:[s.jsxs("h2",{children:[(e=I.find(i=>i.ESGId===parseInt(t)))==null?void 0:e.Title," Preferences"]}),s.jsx("select",{value:S[t],onChange:i=>Se(i,t),multiple:!0,className:"competitionsPrefernces w-full p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm min-h-96",children:H.map((i,n)=>s.jsx("option",{value:i.CompetitionId,children:i.Title},n))})]},"stage_"+t)})})]}),s.jsxs("div",{className:"flex justify-between  w-full",children:[s.jsx("div",{className:"flex timeline flex-col min-w-32 bg-gray-100",children:O.map((t,o)=>s.jsx("div",{className:"flex items-center border-b-2 text-center bg-white p-2",style:{height:`${v}px`},children:s.jsx("div",{className:"w-20",children:t})},o))}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,o])=>s.jsx("div",{className:"bg-gray-200 border-b-2 shadow-md relative flex-1 h-full",children:s.jsx("div",{className:"flex flex-col ",children:o.map((e,i)=>{var n,r;return s.jsx("div",{className:"min-h-6 max-w-full flex-1 flex min-w-72",children:s.jsxs("div",{className:"bg-white absolute border-x-2 border-darkprimary/40 p-2 shadow-sm border-b-2 flex overflow-y-auto justify-between w-full",style:{height:`${e.Height}px`,top:`${e.topPosition}px`},children:[s.jsxs("div",{className:"max-w-[80%] overflow-auto",children:[s.jsx("h3",{className:"text-green-800 font-medium text-xs pb-1 border-b-2 whitespace-nowrap text-ellipsis overflow-hidden",children:e.Title}),s.jsxs("h2",{className:"text-blue-900 font-medium text-sm py-1 border-b-2 whitespace-nowrap ",children:[new Date(e.StartTime).toLocaleTimeString()," - ",new Date(e.EndTime).toLocaleTimeString()]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx("div",{className:"bg-white shadow p-2",children:e.isOffStage?s.jsx("span",{className:"material-symbols-outlined text-2xl text-amber-700",children:"airline_seat_recline_normal"}):s.jsx("span",{className:"material-symbols-outlined text-2xl text-green-600",children:"podium"})}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-yellow-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-yellow-700",children:"settings_accessibility"}),e.ParticipantsCount]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-pink-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-pink-700",children:"hourglass_top"}),e.MaximumMinutes]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-purple-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-purple-700",children:"timer"}),e.Duration,"m"]})]}),s.jsx("div",{children:(n=e.Logs)==null?void 0:n.map((a,l)=>s.jsx("div",{className:"text-red-600 text-xs",children:a},l))})]}),s.jsx("div",{className:"flex flex-col overflow-y-auto bg-white max-h-full pr-4 text-xs",children:(r=e.Participants)==null?void 0:r.map((a,l)=>s.jsx("div",{className:"flex items-center p-2 bg-white text-gray-600 font-medium border-b-2 ",children:s.jsx("div",{children:a})},l))})]},i)},t+"_"+i)})})},t))})]})]})})};export{Ee as default};

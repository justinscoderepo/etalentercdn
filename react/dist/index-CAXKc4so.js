import{r as C,j as e,m as X,u as _,z as I}from"./main-nFqu6Iwq.js";import{L as ee}from"./layoutOuter-DpaCEJcY.js";import{P as te}from"./pageHeader-C-unTTLI.js";import{O as re}from"./OldNewTabLayout-CmmMq9vY.js";import{e as k}from"./navigationUtils-BnJxqO9Q.js";import ae from"./formEditor-DH5fGuoD.js";import{F as E}from"./UserGroupIcon-D3G9sm-D.js";import{F as W}from"./UserIcon-BiZvzAUO.js";import{F as q}from"./XCircleIcon-DM85-8OR.js";import{F as z}from"./CheckCircleIcon-B05SrKtr.js";import{F as se}from"./PencilIcon-BYbJtcdX.js";import{F as ne}from"./TrashIcon-CRkhG7o7.js";import{F as oe}from"./PlusIcon-BVpdR5FA.js";import{F as ie}from"./TableCellsIcon-C0nCAlmi.js";import"./index.esm-B0mHSDf6.js";import"./renderComponents-DZfRtpXe.js";import"./validationMessage-DUun8xcG.js";import"./CheckCircleIcon-Cqgblq_-.js";import"./modalForm-BxW2DWa_.js";import"./dialog-1zeS3zxH.js";import"./keyboard-egSErs5U.js";import"./description-CMZh9nRW.js";import"./use-is-mounted-BBmR8U19.js";import"./XMarkIcon-DBX5D18C.js";function le({title:t,titleId:i,...u},o){return C.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:o,"aria-labelledby":i},u),t?C.createElement("title",{id:i},t):null,C.createElement("path",{fillRule:"evenodd",d:"M6.75 2.25A.75.75 0 0 1 7.5 3v1.5h9V3A.75.75 0 0 1 18 3v1.5h.75a3 3 0 0 1 3 3v11.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3H6V3a.75.75 0 0 1 .75-.75Zm13.5 9a1.5 1.5 0 0 0-1.5-1.5H5.25a1.5 1.5 0 0 0-1.5 1.5v7.5a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5v-7.5Z",clipRule:"evenodd"}))}const V=C.forwardRef(le),de=(t,i)=>{const u=new Date(t);u.setHours(0,0,0,0);const o=new Date(i);o.setHours(0,0,0,0),o.setDate(o.getDate()+1);let f=o.getFullYear()-u.getFullYear(),l=o.getMonth()-u.getMonth(),g=o.getDate()-u.getDate();if(g<0){l--;const A=new Date(o.getFullYear(),o.getMonth(),0);g+=A.getDate()}return l<0&&(f--,l+=12),{years:f,months:l,days:g}},ce=(t,i)=>{const u=new Date(t);u.setHours(0,0,0,0);const o=new Date(i);o.setHours(0,0,0,0),o.setDate(o.getDate()+1);const f=Math.abs(o-u);return Math.ceil(f/(1e3*60*60*24))+1},me=t=>{if(t.years===0&&t.months===0)return`${t.days} ${t.days===1?"day":"days"}`;if(t.years===0)return t.days===0?`${t.months} ${t.months===1?"month":"months"}`:`${t.months} ${t.months===1?"month":"months"}, ${t.days} ${t.days===1?"day":"days"}`;{const i=[];return i.push(`${t.years} ${t.years===1?"year":"years"}`),t.months>0&&i.push(`${t.months} ${t.months===1?"month":"months"}`),t.days>0&&i.push(`${t.days} ${t.days===1?"day":"days"}`),i.join(", ")}},U=t=>{if(!t)return null;const i=t.split("-");return i.length!==3?null:new Date(parseInt(i[2]),parseInt(i[1])-1,parseInt(i[0]))};function ue({formData:t,getValues:i}){const u=t?.BirthDateTo||i?.("BirthDateTo"),o=t?.BirthDateFrom||i?.("BirthDateFrom");if(!u||!o)return null;const f=U(u),l=U(o);if(!f||!l)return null;const g=new Date().getFullYear(),A=new Date(g,l.getMonth(),l.getDate()),d=g-l.getFullYear(),p=g-f.getFullYear(),b=de(f,l),S=ce(f,l),c=b.years===0;return e.jsxs("div",{className:"p-4 bg-surface border border-primary/20 rounded-md",children:[e.jsxs("h4",{className:"text-sm font-semibold text-onSurface mb-3 flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-cyan-600"}),"Calculated Age Group Preview"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Age From (Youngest)"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[d," years"]})]}),e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Age To (Oldest)"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[p," years"]})]}),e.jsxs("div",{className:"bg-surfaceCard p-3 rounded border border-cyan-100",children:[e.jsx("span",{className:"text-xs text-onSurfaceVariant block mb-1",children:"Calculation Date"}),e.jsxs("span",{className:"text-base font-semibold text-onSurface",children:[String(A.getDate()).padStart(2,"0"),"-",String(A.getMonth()+1).padStart(2,"0"),"-",g]})]})]}),e.jsx("div",{className:"bg-emerald-50 p-3 rounded border border-emerald-200",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-xs text-emerald-700 font-medium block mb-1",children:"Birth Date Range Span"}),e.jsx("span",{className:"text-sm font-semibold text-emerald-900",children:me(b)})]}),c&&e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-emerald-700 font-medium block mb-1",children:"Total Days"}),e.jsxs("span",{className:"text-sm font-semibold text-emerald-900",children:[S," ",S===1?"day":"days"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-onSurfaceVariant bg-surfaceCard p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"From (Oldest):"})," ",u]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"To (Youngest):"})," ",o]})]})]})]})}const ge=[{text:"Any",value:"Any",icon:E},{text:"Individual",value:"Individual",icon:W},{text:"Team",value:"Team",icon:E}],he=[{text:"No",value:"No",icon:q},{text:"Yes (Multiple age groups)",value:"Yes",icon:z}],H=t=>{const i=String(t.getDate()).padStart(2,"0"),u=String(t.getMonth()+1).padStart(2,"0"),o=t.getFullYear();return`${i}-${u}-${o}`};function pe({editingGroup:t,existingGroups:i=[],onSubmit:u,onCancel:o,open:f}){const l=C.useMemo(()=>{if(i&&i.length>0){const c=i[0];return{day:c.AgeStartDate||1,month:c.AgeStartMonth||1,year:c.AgeStartYear||new Date().getFullYear()}}return{day:1,month:1,year:new Date().getFullYear()}},[i]),g=(c,y,D)=>{if(!c||!y||!D)return{birthDateFrom:"",birthDateTo:""};try{const j=new Date(D.year,D.month-1,D.day),N=new Date(j);N.setFullYear(N.getFullYear()-y),N.setDate(N.getDate()+1);const T=new Date(j);return T.setFullYear(T.getFullYear()-c+1),{birthDateFrom:H(T),birthDateTo:H(N)}}catch(j){return console.error("Error calculating birth dates from ages:",j),{birthDateFrom:"",birthDateTo:""}}},A=C.useMemo(()=>t?{EventGroupId:t.EventGroupId,GroupName:t.GroupName,BirthDateFrom:t.BirthDateFrom||"",BirthDateTo:t.BirthDateTo||"",AgeFrom:t.AgeFrom||"",AgeTo:t.AgeTo||"",ParticipantType:t.parsedSettings.ParticipantType,IsCommon:t.parsedSettings.IsCommon,NoAgeIdPrefix:t.parsedSettings.NoAgeIdPrefix,Order:t.Order,Status:t.Status}:{Status:2,ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No",AgeFrom:"",AgeTo:""},[t]),d=[{name:"GroupName",label:"Group Name",type:"text",placeholder:"e.g., Juniors, Children, Seniors",validate:{required:!0,minLength:2,maxLength:50}},{name:"ParticipantType",label:"Participant Type",type:"toggle",options:ge,validate:{required:!0}},{name:"BirthDateTo",label:"Birth Date From (Oldest Eligible)",type:"normalDate",maxDate:new Date,placeholder:"Select the birth date of the oldest eligible participant (earliest date)",validate:{required:!0,toField:"BirthDateFrom"}},{name:"BirthDateFrom",label:"Birth Date To (Youngest Eligible)",type:"normalDate",maxDate:new Date,placeholder:"Select the birth date of the youngest eligible participant (most recent)",validate:{required:!0,fromField:"BirthDateTo"}},{name:"AgeFrom",label:"Age From (Youngest Age)",type:"number",placeholder:"e.g., 5",description:`Ages calculated on ${l.day}/${l.month}/${l.year}`,min:0,max:100,validate:{required:!0,min:0,max:100,lessThanOrEqualTo:"AgeTo"}},{name:"AgeTo",label:"Age To (Oldest Age)",type:"number",placeholder:"e.g., 12",min:0,max:100,validate:{required:!0,min:0,max:100,greaterThanOrEqualTo:"AgeFrom"}},{name:"AgePreview",type:"custom",render:c=>e.jsx(ue,{...c})},{name:"IsCommon",label:"Is Common Group",type:"toggle",options:he},{name:"NoAgeIdPrefix",label:"No Age-Based ID Prefix",type:"toggle",options:[{text:"No (Use age prefix)",value:"No",icon:q},{text:"Yes (No prefix)",value:"Yes",icon:z}],conditions:[{key:"IsCommon",value:"No"}]}],p=async(c,...y)=>(c.IsCommon==="Yes"&&(c.NoAgeIdPrefix="Yes"),u(c,...y)),b=(c,y,D)=>{const j=parseInt(c)||0,N=parseInt(y.AgeTo)||0,{birthDateFrom:T,birthDateTo:B}=g(j+1,N,l);D("BirthDateFrom",T),D("BirthDateTo",B)},S=(c,y,D)=>{const j=parseInt(c)||0,N=parseInt(y.AgeFrom)||0,{birthDateFrom:T,birthDateTo:B}=g(N,j,l);D("BirthDateFrom",T),D("BirthDateTo",B)};return e.jsx(ae,{title:t?"Edit Age Group":"Add New Age Group",description:t?"Update age group details by modifying age ranges and calculation dates":"Create a new age group by specifying age ranges and calculation dates",row:A,fields:d,onSave:p,onCancel:o,ageFromOnChange:b,ageToOnChange:S})}function xe({gapInfo:t}){return e.jsxs("div",{className:"relative pb-8",children:[e.jsx("span",{className:"absolute left-6 top-4 -ml-px h-full w-0.5 bg-red-300 border-l-2 border-dashed","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex items-start space-x-3",children:[e.jsx("div",{className:"relative flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full bg-red-100 border-2 border-red-400 border-dashed",children:e.jsx("span",{className:"text-xs font-bold text-red-600",children:"GAP"})}),e.jsx("div",{className:"min-w-0 flex-1",children:e.jsxs("div",{className:"rounded-lg border-2 border-red-200 border-dashed bg-red-50 shadow-sm p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-red-700 mb-2",children:"⚠️ Missing Age Range"}),e.jsxs("div",{className:"text-xs text-red-600 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Gap Ages:"})," ",t.missingAges]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date Range:"})," ",t.dateFrom," to ",t.dateTo]}),e.jsx("p",{className:"italic text-red-500 mt-2",children:"Participants born in this range have no age group assigned!"})]})]})})]})]})}function fe({group:t,onEdit:i,onDelete:u,isLast:o}){const f=t.parsedSettings.ParticipantType==="Individual"?"bg-cyan-500":t.parsedSettings.ParticipantType==="Team"?"bg-emerald-500":"bg-indigo-500",l=t.parsedSettings.ParticipantType==="Individual"?"border-cyan-200":t.parsedSettings.ParticipantType==="Team"?"border-emerald-200":"border-indigo-200",g=t.parsedSettings.ParticipantType==="Individual"?"text-cyan-600":t.parsedSettings.ParticipantType==="Team"?"text-emerald-600":"text-indigo-600",d=(()=>{const p=new Date(t.AgeStartYear,t.AgeStartMonth-1,t.AgeStartDate),b=new Date(p);b.setFullYear(b.getFullYear()-t.AgeTo),b.setDate(b.getDate()+1);const S=new Date(p);S.setFullYear(S.getFullYear()-t.AgeFrom+1);const c=y=>{const D=String(y.getDate()).padStart(2,"0"),j=String(y.getMonth()+1).padStart(2,"0"),N=y.getFullYear();return`${D}-${j}-${N}`};return{from:c(b),to:c(S),minYear:b.getFullYear(),maxYear:S.getFullYear()}})();return e.jsxs("div",{className:"relative pb-8",children:[!o&&e.jsx("span",{className:"absolute left-6 top-8 -ml-px h-full w-0.5 bg-border","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex items-start space-x-3",children:[e.jsx("div",{className:`relative flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full ${f} shadow-sm`,children:e.jsxs("span",{className:"text-base font-bold text-white",children:[t.AgeFrom,"-",t.AgeTo]})}),e.jsxs("div",{className:"min-w-0 flex-1 space-y-3",children:[e.jsxs("div",{className:`rounded-lg border ${l} bg-surfaceCard shadow-sm p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:`text-base font-semibold ${g}`,children:t.GroupName}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>i(t),className:"text-onSurfaceVariant hover:text-primary transition-colors",title:"Edit",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>u(t.EventGroupId),className:"text-onSurfaceVariant hover:text-red-600 transition-colors",title:"Delete",children:e.jsx(ne,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-onSurfaceVariant",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-4 w-4 text-onSurfaceVariant"}),e.jsxs("span",{children:["Age on: ",t.AgeStartDate,"/",t.AgeStartMonth,"/",t.AgeStartYear]})]}),t.parsedSettings.IsCommon==="Yes"&&e.jsx("span",{className:"rounded-full bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-800",children:"Common"}),t.Status!==1&&e.jsx("span",{className:"rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800",children:"Inactive"})]}),e.jsxs("div",{className:"mt-2 text-xs text-onSurfaceVariant",children:["Order: ",t.Order]})]}),e.jsx("div",{className:"rounded-md border border-border bg-surfaceCard shadow-sm p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-onSurfaceVariant flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold text-onSurface mb-1",children:"Birth Date Range (Eligible Participants)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-onSurfaceVariant",children:"From:"}),e.jsx("span",{className:"ml-1 font-medium text-onSurface",children:d.from}),e.jsxs("span",{className:"ml-1 text-onSurfaceVariant",children:["(",d.minYear,")"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-onSurfaceVariant",children:"To:"}),e.jsx("span",{className:"ml-1 font-medium text-onSurface",children:d.to}),e.jsxs("span",{className:"ml-1 text-onSurfaceVariant",children:["(",d.maxYear,")"]})]})]}),e.jsxs("p",{className:"mt-1 text-xs text-onSurfaceVariant italic",children:["Participants born within this date range will be age ",t.AgeFrom,"-",t.AgeTo," on ",t.AgeStartDate,"/",t.AgeStartMonth,"/",t.AgeStartYear]})]})]})})]})]})]})}function ye({groups:t,onEdit:i,onDelete:u,detectGaps:o}){const f=t.filter(d=>d.parsedSettings.ParticipantType==="Individual").sort((d,p)=>(d.Order||0)-(p.Order||0)),l=t.filter(d=>d.parsedSettings.ParticipantType==="Team").sort((d,p)=>(d.Order||0)-(p.Order||0)),g=t.filter(d=>d.parsedSettings.ParticipantType==="Any").sort((d,p)=>(d.Order||0)-(p.Order||0)),A=(d,p,b,S,c)=>{const y=[];return d.forEach((D,j)=>{y.push(e.jsx("li",{children:e.jsx(fe,{group:D,onEdit:i,onDelete:u,isLast:!1})},D.EventGroupId));const N=p.find(T=>T.afterIndex===j);N&&y.push(e.jsx("li",{children:e.jsx(xe,{gapInfo:N})},`gap-${j}`))}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center gap-2 mb-4 pb-2 border-b-2 ${c.border}`,children:[S,e.jsx("h2",{className:`text-base font-semibold ${c.text}`,children:b}),e.jsxs("span",{className:`ml-auto rounded-full ${c.bg} px-2 py-1 text-xs font-medium ${c.badge}`,children:[d.length," groups"]})]}),d.length===0?e.jsxs("p",{className:"text-sm text-gray-500",children:["No ",b.toLowerCase()," defined"]}):e.jsx("div",{className:"flow-root",children:e.jsx("ul",{className:"-mb-8",children:y})})]})};return e.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[(f.length>0||g.length===0)&&A(f,o(f),"Individual Groups",e.jsx(W,{className:"h-6 w-6 text-cyan-600"}),{border:"border-cyan-300",text:"text-cyan-700",bg:"bg-cyan-100",badge:"text-cyan-800"}),(l.length>0||g.length===0)&&A(l,o(l),"Team Groups",e.jsx(E,{className:"h-6 w-6 text-emerald-600"}),{border:"border-emerald-300",text:"text-emerald-700",bg:"bg-emerald-100",badge:"text-emerald-800"}),g.length>0&&e.jsx(e.Fragment,{children:A(g,o(g),"Individual+Team Groups",e.jsx(E,{className:"h-6 w-6 text-indigo-600"}),{border:"border-indigo-300",text:"text-indigo-700",bg:"bg-indigo-100",badge:"text-indigo-800"})})]})}function We(){const{eventDetails:t}=X(),[i,u]=C.useState(null),[o,f]=C.useState(!1),{rows:l,update:g,delete:A,status:d}=_("/AgewiseGroupsJson/Get",{filter:{EventCategory:t?.EventCategory},updateUrl:"/AgewiseGroupsJson/Save",deleteUrl:"/AgewiseGroupsJson/Remove",limit:100,sort:{sortOrder:"ASC",sortColumn:"Order"},select:"EventGroupId,GroupName,AgeFrom,AgeTo,AgeStartDate,AgeStartMonth,AgeStartYear,Status,JsonSettings,Order"});console.log("rows",l);const p=C.useMemo(()=>l?l.map(r=>{let m={ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No"};try{r.JsonSettings&&(m=JSON.parse(r.JsonSettings))}catch(v){console.error("Failed to parse JsonSettings:",v)}return{...r,parsedSettings:m}}):[],[l]),b=r=>{const m=n=>{const s=n.parsedSettings.ParticipantType,a=n.parsedSettings.IsCommon==="Yes";return s==="Individual"&&!a?1:s==="Individual"&&a?2:s==="Team"&&!a?3:s==="Team"&&a?4:5};return[...r].sort((n,s)=>{const a=m(n)-m(s);return a!==0?a:(n.AgeFrom||0)-(s.AgeFrom||0)}).map((n,s)=>({...n,correctOrder:s+1}))},S=async(r,m=!1)=>{if(!r||r.length===0)return;const n=b(r).filter(a=>a.Order!==a.correctOrder);if(n.length===0)return;console.log("Auto-fixing incorrect orders for",n.length,"groups:",n.map(a=>({name:a.GroupName,currentOrder:a.Order,newOrder:a.correctOrder})));const s=n.map(a=>g({EventGroupId:a.EventGroupId,Order:a.correctOrder},!0).catch(h=>(console.error(`Failed to auto-update order for group "${a.GroupName}":`,h),null)));try{const h=(await Promise.all(s)).filter(x=>x!==null).length;!m&&h>0&&console.log(`Auto-fixed order for ${h} group(s)`)}catch(a){console.error("Group order auto-fix errors:",a)}},c=async()=>{if(!p||p.length===0){I.error("No groups available to reorder");return}const r=b(p),m=[];if(r.forEach(n=>{n.Order!==n.correctOrder&&m.push({EventGroupId:n.EventGroupId,GroupName:n.GroupName,currentOrder:n.Order,newOrder:n.correctOrder})}),m.length===0){I.success("All groups are already in correct order");return}console.log("Groups needing order update:",m);const v=m.map(n=>g({EventGroupId:n.EventGroupId,Order:n.newOrder}).catch(s=>{throw console.error(`Failed to update order for group "${n.GroupName}":`,s),s}));try{await Promise.all(v),I.success(`Successfully updated order for ${m.length} group(s)`)}catch(n){I.error("Some group orders failed to update. Check console for details."),console.error("Group order update errors:",n)}},y=r=>{const m=[],v=s=>{const a=String(s.getDate()).padStart(2,"0"),h=String(s.getMonth()+1).padStart(2,"0"),x=s.getFullYear();return`${a}-${h}-${x}`},n=r.map(s=>{const a=new Date(s.AgeStartYear,s.AgeStartMonth-1,s.AgeStartDate),h=new Date(a);h.setFullYear(h.getFullYear()-s.AgeTo),h.setDate(h.getDate()+1);const x=new Date(a);return x.setFullYear(x.getFullYear()-s.AgeFrom+1),{...s,minBirthDate:h,maxBirthDate:x,minBirthDateStr:v(h),maxBirthDateStr:v(x)}});for(let s=0;s<n.length-1;s++){const a=n[s],h=n[s+1],x=new Date(h.maxBirthDate);x.setDate(x.getDate()+1);const w=new Date(a.minBirthDate);if(w.setDate(w.getDate()-1),x<=w){const G=new Date(a.AgeStartYear,a.AgeStartMonth-1,a.AgeStartDate),Y=Math.floor((G-w)/(365.25*24*60*60*1e3)),O=Math.ceil((G-x)/(365.25*24*60*60*1e3));m.push({afterIndex:s,missingAges:Y===O?`Age ${Y}`:`Age ${Y}-${O}`,dateFrom:v(x),dateTo:v(w)})}}return m},D=async r=>{try{const[m,v,n]=(r.BirthDateTo||"1-1-2020").split("-"),[s,a,h]=(r.BirthDateFrom||"31-12-2024").split("-"),x=new Date().getFullYear(),w=new Date(x,parseInt(a)-1,parseInt(s)),G=x-parseInt(h),Y=x-parseInt(n),O=new Date(parseInt(n),parseInt(v)-1,parseInt(m)),Z=new Date(parseInt(h),parseInt(a)-1,parseInt(s)),J=p.find(F=>{if(r.EventGroupId&&F.EventGroupId===r.EventGroupId||F.parsedSettings.ParticipantType!==r.ParticipantType||F.parsedSettings.IsCommon!==r.IsCommon)return!1;const $=new Date(F.AgeStartYear-F.AgeTo,F.AgeStartMonth-1,F.AgeStartDate),P=new Date(F.AgeStartYear-F.AgeFrom,F.AgeStartMonth-1,F.AgeStartDate);return O<=P&&Z>=$});if(J){I.error(`Date range overlaps with existing group "${J.GroupName}". Please adjust the dates to avoid overlap within the same Participant Type and Common Group status.`);return}const Q={EventGroupId:r.EventGroupId||0,EventCategory:t?.EventCategory,GroupName:r.GroupName,AgeFrom:G,AgeTo:Y,AgeStartDate:w.getDate(),AgeStartMonth:w.getMonth()+1,AgeStartYear:w.getFullYear(),Status:1,Order:r.Order||(l?.length||0)+1,JsonSettings:JSON.stringify({ParticipantType:r.ParticipantType,IsCommon:r.IsCommon,NoAgeIdPrefix:r.NoAgeIdPrefix}),BirthDateFrom:r.BirthDateFrom,BirthDateTo:r.BirthDateTo},K=await g(Q,!1,!0),[be,De,Ne,M]=K,R=Array.isArray(M)&&M.length>0?M[0]:null;if(R){console.log("Latest data after save:",R);const F=R.map($=>{let P={ParticipantType:"Any",IsCommon:"No",NoAgeIdPrefix:"No"};try{$.JsonSettings&&(P=JSON.parse($.JsonSettings))}catch(L){console.error("Failed to parse JsonSettings:",L)}return{...$,parsedSettings:P}});await S(F,!0)}I.success(i?"Group updated successfully":"Group added successfully"),u(null),f(!1)}catch(m){I.error("Failed to save group"),console.error(m)}},j=async r=>{if(window.confirm("Are you sure you want to delete this age group?"))try{const m=await A({EventGroupId:r}),[v,n,s]=m;setTimeout(async()=>{try{const a=p.filter(h=>h.EventGroupId!==r);a.length>0&&await S(a,!0)}catch(a){console.error("Failed to auto-fix orders after delete:",a)}},1e3),I.success("Group deleted successfully")}catch{I.error("Failed to delete group")}},N=r=>{let m="",v="";if(r.AgeFrom&&r.AgeTo&&r.AgeStartYear&&r.AgeStartMonth&&r.AgeStartDate)try{const s=new Date(r.AgeStartYear,r.AgeStartMonth-1,r.AgeStartDate),a=new Date(s);a.setFullYear(a.getFullYear()-r.AgeTo),a.setDate(a.getDate()+1);const h=w=>{const G=String(w.getDate()).padStart(2,"0"),Y=String(w.getMonth()+1).padStart(2,"0"),O=w.getFullYear();return`${G}-${Y}-${O}`};v=h(a);const x=new Date(s);x.setFullYear(x.getFullYear()-r.AgeFrom+1),m=h(x)}catch(s){console.error("Error calculating birth dates for editing:",s)}const n={...r,BirthDateFrom:r.BirthDateFrom||m,BirthDateTo:r.BirthDateTo||v};u(n),f(!0)},T=()=>{u(null),f(!1)},B=[{title:"New Page",path:k("/SetUp/ManageGroups")},{title:"Old Page",path:k("/SetUp/ManageGroupsOld")},{title:"Old Table View",path:k("/AgewiseGroups/Manage")}];return e.jsx(re,{tabs:B,children:e.jsx(ee,{children:e.jsxs("div",{className:"flex flex-col grow",children:[e.jsx(te,{heading:"Age Groups Setup",subHeading:"Manage participant age categories and groups",rightChildren:e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>f(!o),className:"inline-flex items-center gap-x-2 rounded-lg bg-gradient-to-r from-primary to-darkprimary px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:shadow-lg hover:scale-105 transition-all duration-200",children:[e.jsx(oe,{className:"h-5 w-5"}),o?"Cancel":"Add New Group"]}),e.jsxs("button",{onClick:c,disabled:d==="loading",className:"inline-flex items-center gap-x-2 rounded-lg bg-emerald-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md hover:shadow-lg hover:scale-105 transition-all duration-200 disabled:bg-surfaceVariant disabled:scale-100",children:[e.jsx(ie,{className:"h-5 w-5"}),"Fix Order"]})]})}),o&&e.jsx(pe,{editingGroup:i,existingGroups:p,onSubmit:D,onCancel:T,open:o}),e.jsx("div",{className:"bg-surface border border-primary/20 rounded-xl p-5 mb-6 shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-blue-100 rounded-lg p-2 flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-onSurface mb-1",children:"Quick Guide"}),e.jsx("p",{className:"text-sm text-onSurfaceVariant leading-relaxed mb-2",children:"Organize participants into age-based groups. Groups are automatically ordered by priority (Individual → Team → Any) and age range."}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs text-onSurfaceVariant",children:[e.jsx("li",{children:"Cyan badges represent Individual participants, Emerald for Teams, Indigo for Any type"}),e.jsx("li",{children:"Red dashed gaps indicate missing age ranges between groups"}),e.jsx("li",{children:'Use "Fix Order" button to manually reorder groups when needed'})]})]})]})}),d==="loading"&&e.jsx("div",{className:"text-center py-8 text-onSurfaceVariant",children:"Loading groups..."}),d==="error"&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-red-500",children:"Error loading age groups. Please try refreshing the page."})}),(d==="success"||d==="finished")&&(!l||l.length===0)&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-onSurfaceVariant",children:'No age groups found. Click "Add New Group" to get started.'})}),(d==="success"||d==="finished")&&l&&l.length>0&&e.jsx(ye,{groups:p,onEdit:N,onDelete:j,detectGaps:y}),e.jsx("div",{className:"mt-8 pt-6 border-t border-border",children:e.jsxs("p",{className:"text-xs text-onSurfaceVariant",children:[e.jsx("strong",{className:"text-primary",children:"What's next?"})," ",e.jsx("a",{href:"/SetUp/ManageCompetitionItems",className:"underline hover:text-primary",children:"Add Competition Items"})," ","|"," ",e.jsx("a",{href:"/CompetitionStructure/Tab",className:"underline hover:text-primary",children:"Assign Competitions to Groups"})," ","|"," ",e.jsx("a",{href:"/Coordinator/ManageBulkParticipants",className:"underline hover:text-primary",children:"Add Participants"})]})})]})})})}export{We as default};

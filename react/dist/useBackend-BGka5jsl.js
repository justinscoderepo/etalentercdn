import{r as S,_ as M}from"./mainweb-kN1oebse.js";import{t as n,b as D,p as _,r as ee}from"./httpService-DyKyZ8oa.js";window.activeRequests={};window.counts={};window.requests={};window.requestCache={};window.firstTimeRequests={};window.localRequestCache={};window.noGetRequests={};try{let a=sessionStorage.getItem("requestCache"),k=JSON.parse(a);k&&(requestCache=k)}catch{}var Y=window.location.href;sessionStorage.getItem("currenturl")==Y&&(sessionStorage.removeItem("requestCache"),requestCache={});sessionStorage.setItem("currenturl",Y);const se=(...a)=>{let k=!1;return a.forEach(C=>{(C=="fetching"||C=="started"||C=="waiting")&&(k=!0)}),k},ie=(a,{mandatoryValues:k,mandatoryParams:C,select:y,filter:P,sort:j,offset:v,limit:A,noGet:W,doCache:K,deleteUrl:Z,updateUrl:$})=>{counts[a]||(counts[a]=0);let[l,z]=S.useState(P??{});n("filters",l);let[f,H]=S.useState(j??{sortColumn:"id",sortOrder:"ASC"}),[h,J]=S.useState(v??0),[q,Q]=S.useState(A??1e3);K&&(l.isCache=!0);let[x,b]=S.useState(counts[a]),[m,p]=S.useState("fetching"),[I,N]=S.useState(""),[s,O]=S.useState(null),t=E(a,y,l,f,h,q);n("🔯 useBackend for "+t);const d=(e,r,c)=>{r==z&&n("useBackend for "+t+" trying to setting filters with "+JSON.stringify(c)),Object.keys(activeRequests).length===0?(r==O&&n("useBackend for "+t+" trying to set response",c),r==O&&n("useBackend for "+t+" setting response with ",c),r(c),e=c):(r!=O&&(e=c),r==O&&n("useBackend for "+t+" waiting to set response with ",c),setTimeout(()=>{d(e,r,c)},1e3))},B=async e=>{let r=typeof e<"u";if(n("mandatoryParams",C),C){let u=[];if(C.forEach(o=>{l[o]||u.push(o)}),u.length){n("useBackend for "+t+" missing params "+u.join(", "));return}}I!=""&&d(I,N,"");try{if(requests[t]="",firstTimeRequests[t]=!0,activeRequests[t]&&!r){n("useBackend for "+t+" waiting in "+window.location.href);return}activeRequests[t]=!0}catch{delete activeRequests[t]}n("🌐 useBackend calling api "+t+" with filters "+JSON.stringify(l));let c={};e&&(c={takeNew:!0,requestDate:new Date().toISOString()}),noGetRequests[t]=!1;let i={};try{i=await D(""+a,y,{...l,...c},f,h,q),n("🌐 useBackend for "+t+" got response ",i);try{if(t){let u=JSON.stringify(i.data);requests[t]&&console.error({repeatedCalls:{key:t,res:u}}),requests[t]=u}}catch{n("error in setting request")}if(!(i.data?.Results instanceof Array)&&typeof i.data?.Results=="object"?i.data.data=[i.data?.Results]:i.data.data=i.data?.Results&&i.data?.Results?.map&&i.data?.Results?.map((u,o)=>({...u,index:o+1})),i.data?.error)alert(i.data.error),M.error(i.data.message+", please reload or try again"),d(I,N,i.data.message);else{try{localRequestCache[t]=i.data,n("useBackend for "+t+" setting local cache with ",localRequestCache[t]),K&&i.data.data?.length&&(requestCache[t]=i.data,sessionStorage.setItem("requestCache",JSON.stringify(requestCache)))}catch{delete requestCache[t],delete localRequestCache[t],n("requestCache not working"),i={data:{data:[]}}}delete activeRequests[t],d(s,O,{data:{...i.data}})}}catch(u){M.error(u.message+", please reload or try again"),d(I,N,u.message),delete requestCache[t],delete localRequestCache[t],i={data:{data:[]}}}return delete activeRequests[t],p("finished"),counts[a]=counts[a]+1,d(x,b,counts[a]),[i.data?.data]};let L=!1,T="";try{K&&(n("useBackend for "+t+" localRequestCache",localRequestCache[t]),requestCache[t]&&(T=t,L=!0))}catch{n("requestCache not working")}if(t&&W&&noGetRequests[t]==null&&(noGetRequests[t]=!0),!a)throw new Error("url is required");let U=!1;L&&(s?.data?.data?.length||(n("requestCache",requestCache),s={data:{data:requestCache[T].data}},m="finished",counts[a]=counts[a]+1,x=counts[a],n("useBackend for "+t+" got data from cache"),U=!0));let V=!W;(noGetRequests[t]==null||noGetRequests[t]==!1)&&(V=!0);let X=!1;if(V&&!U){n("localRequestCache",localRequestCache);let e=a+JSON.stringify({select:y,filters:l,localSort:f,localOffset:h,localLimit:q});firstTimeRequests[e]?activeRequests[e]?n("waiting for "+e+" in "+window.location.href):localRequestCache[e]&&(s={data:{data:localRequestCache[e].data}},m="finished",counts[a]=counts[a]+1,x=counts[a],n("useBackend for "+e+" getting data from local cache",s)):(X=!0,B(),n("useBackend for "+e+" getting data for the first time"))}else n("useBackend for "+t+" not calling api as noGet is true or cache is restored");S.useEffect(()=>{if(!X){let e=20,r=setInterval(()=>{localRequestCache[t]&&(clearInterval(r),p("finished")),activeRequests[t]||(clearInterval(r),p("finished")),e--,e<=0&&(clearInterval(r),p("finished"))},1e3)}},[]);let w={rows:null,row:null};return(s?.data?.data?.length||m=="finished")&&(s?.data?.data?.length?(w.rows=s.data?.data,s?.data?.data?.length&&(w.row=s.data?.data[0])):w.rows=[]),w.setFilter=async e=>{v=0;let r=!1;return typeof e=="boolean"?(e={},r=!0):e&&Object.keys(e).length&&(r=!0),d(h,J,0),l={...l,...e},d(l,z,{...l,...P}),t=E(a,y,l,f,h,q),n("useBackend for "+t+" setting filter with "+JSON.stringify(e)),await B(r)},w.setSort=async e=>(j={...j,...e},d(f,H,{...j,...e}),n("useBackend for "+t+" setting sort with "+JSON.stringify(e)),t=E(a,y,l,f,h,q),await B(!0)),w.setLimit=async e=>(A=e,v=0,d(q,Q,e),d(h,J,0),n("useBackend for "+t+" setting limit with "+e),t=E(a,y,l,f,h,q),await B(!0)),w.setOffset=async e=>(v=e,d(h,J,e),n("useBackend for "+t+" setting offset with "+e),t=E(a,y,l,f,h,q),await B(!0)),w.setOffsetAndLimit=async(e,r,c,i)=>(v=e,A=r,j={sortColumn:c,sortOrder:i},q=r,h=e,f=j,d(h,J,e),d(q,Q,r),d(f,H,{sortColumn:c,sortOrder:i}),n("useBackend for "+t+" setting offset with "+e+" and limit with "+r),t=E(a,y,l,f,h,q),await B(!0)),w.setWholeData=e=>{O({...s,rows:{...s.data,rows:e}})},w.updateLocal=e=>{let r=s?.data?.data?.findIndex(c=>c.id===e.id);if(r>=0&&(e={...s.data.data[r],...e}),s?.data?.data||(s={data:{data:[]}}),r>=0)s.data.data[r]=e;else{let c=s?.data?.data?.length?s.data.data.length:0;f?.sortOrder=="DESC"?(e.index=1,s.data.data=[e,...s.data.data.map((i,u)=>({...i,index:u+2}))]):(e.index=c+1,s.data.data=[...s.data.data,e])}O({...s}),counts[a]=counts[a]+1,d(x,b,counts[a])},w.update=async(e,r,c,i)=>{let u={...e};delete u.index;try{let o=await _($||a,u);if(i&&i("It's Saved"),o.data?.Results){if(o?.data?.Results?.IsSuccess==!1&&o?.data?.Results?.Message)return M.error(o?.data?.Results?.Message),Promise.reject({message:o?.data?.Results?.Message});if(L){let R=T.split("{")[0];Object.keys(requestCache).forEach(g=>{g.startsWith(R)&&delete requestCache[g]}),sessionStorage.setItem("requestCache",JSON.stringify(requestCache))}if(o.data?.Results instanceof Array&&typeof o.data?.Results=="object"){let R=s?.data?.data?.findIndex(g=>g.id===o.data.data.id);if(e.id=o.data.data.id,R>=0&&(e={...s.data.data[R],...e}),s?.data?.Results||(s={data:{data:[]}}),!r){if(R>=0)s.data.data[R]=e;else{let g=s?.data?.data?.length?s.data.data.length:0;f?.sortOrder=="DESC"?(e.index=1,s.data.data=[e,...s.data.data.map((G,F)=>({...G,index:F+2}))]):(e.index=g+1,s.data.data=[...s.data.data,e])}O({...s}),d(m,p,"finished"),counts[a]=counts[a]+1,d(x,b,counts[a])}}else c=!0,d(m,p,"finished"),counts[a]=counts[a]+1,d(x,b,counts[a]);return c&&(i&&i("Refreshing"),d(m,p,"refreshing"),t=E(a,y,l,f,h,q),await B(!0)),[e,s.data.data,o.data]}else{d(m,p,"finished");let R=s?.data?.SecurityValidations;if(R)return d(I,N,R.join(`
`)),Promise.reject({message:R.join(`
`)});if(o?.data?.modelState){let g=[];return o?.data?.modelState.forEach(G=>{g.push(G.Key+": "+G.Value)}),d(I,N,g.join.join(`
`)),Promise.reject({message:g.join(`
`)})}else return Promise.reject({message:o.data.message})}}catch(o){let g=o.response?.data?.SecurityValidations;return g?(d(o,N,g.join(`
`)),Promise.reject({message:g.join(`
`)})):Promise.reject(o)}},w.delete=async(e,r)=>{let c={...e};try{let i=await ee(Z||a,c);if(i.data.Results)return await B(!0),[e,s.data.data,i];if(d(m,p,"finished"),i?.data?.modelState){let u=[];return i?.data?.modelState.forEach(o=>{u.push(o.Key+": "+o.Value)}),d(I,N,u.join.join(`
`)),Promise.reject({message:u.join(`
`)})}else return Promise.reject({message:"Something went wrong"})}catch(i){return Promise.reject(i)}},{...w,status:m,counter:x,localSort:f,localOffset:h,localLimit:q,filters:l}};function E(a,k,C,y,P,j){try{return a+JSON.stringify({select:k,filters:C,localSort:y,localOffset:P,localLimit:j})}catch{n("error in key generation")}return a}export{se as i,ie as u};

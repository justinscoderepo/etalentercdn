import{r as g,j as s,L as we}from"./mainweb-VYqdl1z5.js";import{B as ye}from"./box-COHCKGan.js";import{u as p,i as Ne}from"./useBackend-C-RX7BFM.js";import{p as q}from"./httpService-BG7VOb7A.js";import{L as je}from"./lazyFunction-CEQZ3rnc.js";import"./utilities-CN4lTu6a.js";import"./index-BtuGy7By.js";const Ge=async(u,C)=>{var I={};if(u.JsonSettings!=null&&u.JsonSettings!=""){var b=JSON.parse(u.JsonSettings);I=b}I.scheduleSettings=C;var v=JSON.stringify(I,null,2);await q("/EventJson/Save",{Select:"EVId,JsonSettings",EVId:u.EVId,JsonSettings:v})};let j={};sessionStorage.getItem("allpreferences")&&(j=JSON.parse(sessionStorage.getItem("allpreferences")));const Re=()=>{var W,z,K;const[u,C]=g.useState([]),[I,b]=g.useState(!1);let[v,Q]=g.useState({}),[Me,ve]=g.useState(4),[De,Le]=g.useState(1),A=localStorage.getItem("preferences"),f=localStorage.getItem("startTime"),D=localStorage.getItem("startDate"),H=localStorage.getItem("timeGap")||10,[S,$]=g.useState(A?JSON.parse(A):{}),c=new Date;if(D&&(c=new Date(D)),c.setHours(9,0,0,0),f){let t=f.split(":");c.setHours(t[0],t[1].split(" ")[0],0,0)}const{row:P}=p("/EventJson/Get",{select:"EVId,JsonSettings",doCache:!0});let k=P==null?void 0:P.JsonSettings,L=k?JSON.parse(k):{},R=(W=L.scheduleSettings)==null?void 0:W.scheduleListPreferences,_=(z=L.scheduleSettings)==null?void 0:z.scheduleStartTime,B=(K=L.scheduleSettings)==null?void 0:K.scheduleStartDate;g.useEffect(()=>{_&&(f=_),B&&(D=B),R&&$(R)},[P]);const{rows:w,status:X}=p("/EventStagesJson/Get",{select:"ESGId,Title,Venue",limit:1e3,offset:0,filter:{status:1},doCache:!0}),{rows:h,status:Y}=p("/CompetitionStructureJson/GetReadyToStart",{filter:{ParticipantType:1,status:1},sort:{sortOrder:"ASC",sortColumn:"GroupOrder"},select:"CompetitionStructureId,CompetitionItem,CompetitionItemTitle,GroupGroupName,ParticipantType,ParticipantTypeTitle,MaximumMinutes,MaximumSeconds,Gender,Language,GenderGenderTitle,LanguageLanguageName,CompetitionStructureId,CompetitionItem,ParticipantType,MaximumMinutes,MaximumSeconds",doCache:!0,limit:1e3,offset:0}),{rows:T,status:Z}=p("/CompetitionParticipantsJson/Get",{select:"ParticipantId,IdentityNumber,Competition,Candidate,Team",filter:{ParticipantType:1,status:1},doCache:!0,limit:1e4,offset:0});console.log({participants:T});const{rows:ee,status:te}=p("/UsersRolesPlusUsersJson/Get",{select:"UserId,UserName,UserRoleId,UserRoleId,UserJsonSettings,UserDobString,UserImage,UserMobile,UserPhone,Email,Group,IdentityNumber,CandidateUser,UserJsonSettings",filter:{status:1},doCache:!0,limit:1e4,offset:0}),{rows:ie}=p("/CompetitionParticipantsTeamsJson/Get",{select:"TeamId,TeamName,TeamStrength,TeamMembersList,TeamMembers,TeamStrength,IdentityNumber",filter:{status:1},doCache:!0,limit:1e4,offset:0});let{rows:V,status:oe}=p("/competitionItemsJson/Get",{select:"CompetitionId,Title,Category,CategoryCategoryName",filter:{status:1},limit:1e3,doCache:!0});p("/CompetitionParticipantsTeamMembersJson/Get",{select:"*",limit:1e3,filter:{status:1},doCache:!0});let{rows:x,status:se}=p("/CompetitionScheduleJson/Get",{filter:{CompetitionParticipantType:1,status:1},select:"ScheduledStartTime,Stage,Competition,CompetitionParticipantType,ExpectedTotalTimeInMinutes,Ischeduled,ScheduledEndTime,CompetitionCompetitionItem,CompetitionCompetitionItemTItle,CompetitionCompetitionStructureId,CompetitionMaximumMinutes,CompetitionMaximumSeconds,CompetitionMinimumMinutes,CompetitionMinimumSeconds,CompetitionWarningMinute,CompetitionWarningSecond,Phase,PhaseTitle,StageTitle,Status,Event,EventEventName,Order,CreatedBy,CreatedDate,ModifiedDate,ScheduleId,JsonSettings,EventGlobal,Participants,CompetitionPreviosGapInMinutes,AvoidChangeStage",limit:1e3,doCache:!0,offset:0}),F=[];x!=null&&x.length&&(h!=null&&h.length)&&(x=x.filter(t=>h.some(i=>i.CompetitionStructureId===t.Competition)));let J=Ne(X,Y,Z,te,oe,se),G=10,M=70,E=c,ne=72*60/G,O=Array.from(Array(ne),(t,i)=>{const e=i*G;return new Date(E.getTime()+e*60*1e3).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})});g.useEffect(()=>{J||h&&T&&w&&x&&(b(!1),y())},[J]);const y=async()=>{je(async()=>{if(!I){b(!0);let t=JSON.stringify(S);j[c+"_"+t]&&C(j[c+"_"+t]);let i={};T.forEach(r=>{var a,l;r.Team==0?i[r.Candidate]=((a=ee.find(d=>d.UserRoleId===r.Candidate))==null?void 0:a.IdentityNumber)??"":i[r.Team]=((l=ie.find(d=>d.TeamId===r.Team))==null?void 0:l.IdentityNumber)??"",i[r.Candidate]||delete i[r.Candidate]});const e=re(),o=ae();let n=me(o);for(let r of n){const a=de(r,i);console.log({event:a});const l=fe(a,e);l&&await ue(l,a,e)}j[c+"_"+t]=e,sessionStorage.setItem("allpreferences",JSON.stringify(j)),C(e),b(!1)}},2e3)},re=()=>{const t={};return w.forEach(i=>{t[i.ESGId]=[]}),C(t),t},ae=()=>h.filter(t=>!F.some(i=>i.Competition===t.CompetitionStructureId)),le=(t,i)=>{let e=t.target.value;localStorage.setItem(i,e),Q({...v,[i]:e}),setTimeout(()=>{b(!1),y()},1e3)},me=t=>{let i=[...F];return t.length>0&&i.push(...t.map(e=>({CompetitionStructureId:e.CompetitionStructureId,Competition:e.CompetitionStructureId,CompetitionCompetitionItemTitle:e.CompetitionItemTitle,GroupGroupName:e.GroupGroupName,CompetitionParticipantTypeTitle:e.ParticipantTypeTitle,CompetitionMaximumMinutes:e.MaximumMinutes,CompetitionMaximumSeconds:e.MaximumSeconds,CompetitionGenderGenderTitle:e.GenderGenderTitle,CompetitionLanguageLanguageName:e.LanguageLanguageName}))),console.log({mergedSchedules:i}),i},de=(t,i)=>{const e=h.find(m=>m.CompetitionStructureId===t.Competition),o=V.find(m=>m.CompetitionId===e.CompetitionItem);e!=null&&e.MaximumMinutes||console.error("Competition Maximum Minutes not found for competition: ",e);const n=parseFloat((e==null?void 0:e.MaximumMinutes)||20),r=T.filter(m=>m.Competition===t.Competition).length;let l=[8,1,105,107].includes(o.Category);const d=ce(n,e,r,l);return{CompetitionStructureId:e.CompetitionStructureId,Title:`${e.ParticipantType==1?"ðŸ•º":"ðŸ‘«"} ${e.GroupGroupName} ${e.CompetitionItemTitle}${e.Gender!=3?" "+e.GenderGenderTitle:""} ${e.Language!=4?" "+e.LanguageLanguageName:""}`,Duration:d,ParticipantsCount:r,MaximumMinutes:n,perTimeLimit:e.MaximumMinutes,isOffStage:l,Logs:[],allParticipants:T.filter(m=>m.Competition===e.CompetitionStructureId).map(m=>m.Candidate>0?m.Candidate:m.Team),Participants:T.filter(m=>m.Competition===e.CompetitionStructureId&&i[m.Candidate>0?m.Candidate:m.Team]).map(m=>i[m.Candidate>0?m.Candidate:m.Team])}},ce=(t,i,e,o)=>{const n=parseFloat(H)||10;let r=o?t:t*e+n;return r%10===0?r:r+(10-r%10)},ue=async(t,i,e)=>{const o=i.Duration/G*M;e[t.ESGId]||(e[t.ESGId]=[]),o>0&&(e[t.ESGId].push({...i,...t,Height:o}),C({...e}),await new Promise(n=>setTimeout(n,1e3)))};let pe=(t,i)=>{let e=S[i];if(!e)return!1;let o=h.find(n=>n.CompetitionStructureId===t.CompetitionStructureId);return e.find(n=>n==o.CompetitionItem)};const fe=(t,i)=>{for(let e=0;e<O.length;e++){const o=e*M,n=t.Duration/G,r=o+M*n,a=ge(O[e]),l=new Date(a);l.setMinutes(l.getMinutes()+t.Duration);for(let d of w){const m=i[d.ESGId]||[];if(!pe(t,d.ESGId))continue;let N={StartTime:a,EndTime:l,topPosition:o,bottomPosition:r,stage:d,ESGId:d.ESGId};if(he(N,m)&&!Se(t,i,N))return{...N}}}return null},Se=(t,i,e)=>{var n;for(let r of w)if(((n=e==null?void 0:e.stage)==null?void 0:n.Title)!=r.Title){t.CompetitionStructureId==5622;const a=i[r.ESGId]||[];for(var o of a){let l=!1;if(e.topPosition<o.bottomPosition&&e.bottomPosition>o.topPosition&&(l=!0),e.topPosition>o.bottomPosition&&e.bottomPosition<o.topPosition&&(l=!0),e.topPosition>o.topPosition&&e.topPosition<o.topPosition&&(l=!0),e.bottomPosition>o.topPosition&&e.bottomPosition<o.topPosition&&(l=!0),l){let d=[];for(let m of o.Participants)for(let N of t.Participants)m===N&&d.push(m);if(d.length>0)return t.Logs.push(d.join(", ")+` - ${o.StartTime.toLocaleTimeString()} - ${o.EndTime.toLocaleTimeString()} @ ${o.stage.Title} - ${o.Title}`),!0}}}return!1},he=(t,i,e)=>{let o=!0;for(let n of i){if(n.topPosition<t.bottomPosition&&n.bottomPosition>t.topPosition||n.topPosition>t.bottomPosition&&n.bottomPosition<t.topPosition||n.topPosition>t.topPosition&&n.topPosition<t.topPosition||n.bottomPosition>t.topPosition&&n.bottomPosition<t.topPosition)return o=!1,o;if(!o)return o}return o},ge=t=>{const i=t.split(":"),e=new Date(c);return e.setHours(i[0],i[1].split(" ")[0],0,0),e},xe=()=>{window.print()},Ce=(t,i)=>{let e=Array.from(t.target.selectedOptions,a=>a.value),o=S[i]||[],n=o.filter(a=>e.includes(a));o=o.filter(a=>!n.includes(a));let r=e.filter(a=>!n.includes(a));o=[...new Set([...o,...r])],S[i]=o,$({...S}),localStorage.setItem("preferences",JSON.stringify(S)),setTimeout(()=>{U(),y()},1e3)},U=()=>{Ge(P,{scheduleListPreferences:S,scheduleStartTime:c,scheduleStartDate:c})},be=t=>{let i=t.target.value,e=i.split(":");E.setHours(e[0],e[1].split(" ")[0],0,0),localStorage.setItem("startTime",i),f=i,setTimeout(()=>{U(),y()},1e3)},Te=t=>{const i=new Date(t.target.value);if(i.setHours(9,0,0,0),f){let e=f.split(":");i.setHours(e[0],e[1].split(" ")[0],0,0)}E=i,f=i,localStorage.setItem("startDate",i),setTimeout(()=>{U(),y()},1e3)};let Ie=c.toISOString().split("T")[0];const Pe=()=>{let t=1;for(let i in u)for(let e of u[i]){let o=e.StartTime,n=e.EndTime,r=e.ESGId,a={ScheduledStartTimeString:o,ScheduledEndTimeString:n,Stage:r,Competition:e.CompetitionStructureId,order:t};t++;let l=x.find(d=>d.Competition===e.CompetitionStructureId);l&&(a.scheduleId=l.ScheduleId),q("/CompetitionScheduleJson/Save",a)}};return s.jsx(ye,{heading:"Automated Schedule",children:J?s.jsx(we,{}):s.jsxs("div",{className:"flex justify-between flex-col w-full print-hidden",children:[s.jsxs("div",{className:"flex justify-end",children:[s.jsx("button",{className:"bg-green-800 px-2 text-white rounded-md",onClick:Pe,children:s.jsx("span",{className:"material-symbols-outlined text-xs text-white",children:"save"})}),s.jsx("button",{className:"bg-blue-800 px-2 text-white rounded-md",onClick:xe,children:s.jsx("span",{className:"material-symbols-outlined text-xs text-white",children:"print"})})]}),s.jsxs("div",{className:"flex justify-between  w-full print:hidden",children:[s.jsxs("div",{className:"flex timeline flex-col w-32 bg-gray-100",children:[s.jsx("label",{htmlFor:"preferredStartDate",className:"block text-sm font-medium text-gray-700 p-2",children:"Preferred Start Date"}),s.jsx("input",{type:"date",value:Ie,className:"p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>Te(t)}),s.jsx("input",{type:"time",value:f,className:"p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"preferredStartDate",name:"preferredStartDate",onChange:t=>be(t)}),s.jsx("input",{type:"number",value:H,className:"p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",id:"timeGap",name:"timeGap",onChange:t=>le(t,"timeGap")})]}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,i])=>{var e;return s.jsxs("div",{className:"bg-white p-2 border-b-2 shadow-md relative flex-1 h-full",children:[s.jsxs("h2",{children:[(e=w.find(o=>o.ESGId===parseInt(t)))==null?void 0:e.Title," Preferences"]}),s.jsx("select",{value:S[t],onChange:o=>Ce(o,t),multiple:!0,className:"competitionsPrefernces w-full p-2 border-b-2 border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm min-h-96",children:V.map((o,n)=>s.jsx("option",{value:o.CompetitionId,children:o.Title},n))})]},"stage_"+t)})})]}),s.jsxs("div",{className:"flex justify-between  w-full",children:[s.jsx("div",{className:"flex timeline flex-col min-w-32 bg-gray-100",children:O.map((t,i)=>s.jsx("div",{className:"flex items-center border-b-2 text-center bg-white p-2",style:{height:`${M}px`},children:s.jsx("div",{className:"w-20",children:t})},i))}),s.jsx("div",{className:"flex flex-1 h-full w-full",children:Object.entries(u).map(([t,i])=>s.jsx("div",{className:"bg-gray-200 border-b-2 shadow-md relative flex-1 h-full",children:s.jsx("div",{className:"flex flex-col ",children:i.map((e,o)=>{var n,r;return s.jsx("div",{className:"min-h-6 max-w-full flex-1 flex min-w-72",children:s.jsxs("div",{className:"bg-white absolute border-x-2 border-darkprimary/40 p-2 shadow-sm border-b-2 flex overflow-y-auto justify-between w-full",style:{height:`${e.Height}px`,top:`${e.topPosition}px`},children:[s.jsxs("div",{className:"max-w-[80%] overflow-auto",children:[s.jsx("h3",{className:"text-green-800 font-medium text-xs pb-1 border-b-2 whitespace-nowrap text-ellipsis overflow-hidden",children:e.Title}),s.jsxs("h2",{className:"text-blue-900 font-medium text-sm py-1 border-b-2 whitespace-nowrap ",children:[new Date(e.StartTime).toLocaleTimeString()," - ",new Date(e.EndTime).toLocaleTimeString()]}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx("div",{className:"bg-white shadow p-2",children:e.isOffStage?s.jsx("span",{className:"material-symbols-outlined text-2xl text-amber-700",children:"airline_seat_recline_normal"}):s.jsx("span",{className:"material-symbols-outlined text-2xl text-green-600",children:"podium"})}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-yellow-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-yellow-700",children:"settings_accessibility"}),e.ParticipantsCount]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-pink-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-pink-700",children:"hourglass_top"}),e.perTimeLimit??"?"]}),s.jsxs("div",{className:"bg-white shadow p-2 justify-center text-center text-xs font-bold text-purple-700",children:[s.jsx("span",{className:"material-symbols-outlined text-2xl text-purple-700",children:"timer"}),e.Duration,"m"]})]}),s.jsx("div",{children:(n=e.Logs)==null?void 0:n.map((a,l)=>s.jsx("div",{className:"text-red-600 text-xs",children:a},l))})]}),s.jsx("div",{className:"flex flex-col overflow-y-auto bg-white max-h-full pr-4 text-xs",children:(r=e.Participants)==null?void 0:r.map((a,l)=>s.jsx("div",{className:"flex items-center p-2 bg-white text-gray-600 font-medium border-b-2 ",children:s.jsx("div",{children:a})},l))})]},o)},t+"_"+o)})})},t))})]})]})})};export{Re as default};

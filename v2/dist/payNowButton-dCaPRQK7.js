import{r as a,H as ie,z as $,j as e,i as V,p as ce}from"./main-BCzkGS41.js";import{c as le}from"./computeTotalAmount-SLrtDhPw.js";import{V as de}from"./validationMessage-CuS4UUNG.js";import{F as K}from"./CheckCircleIcon-I_fobL__.js";import{F as Q}from"./CreditCardIcon-GDKptZPg.js";import{F as k}from"./ExclamationTriangleIcon-_gIvK7AQ.js";class me{constructor(){this.ws=null,this.listeners=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=60,this.reconnectDelay=3e4,this.isIntentionallyClosed=!1}connect(t,r={}){if(this.ws&&this.ws.readyState===WebSocket.OPEN){console.log("WebSocket already connected");return}this.isIntentionallyClosed=!1;try{const o=this.buildUrl(t,r.queryParams);this.ws=new WebSocket(o),this.ws.onopen=()=>{console.log("WebSocket connected"),this.reconnectAttempts=0,this.notifyListeners("connection",{status:"connected"}),r.token&&this.send("authenticate",{token:r.token})},this.ws.onmessage=c=>{try{const m=JSON.parse(c.data);console.log("WebSocket message received:",m),this.notifyListeners(m.type||"message",m.data||m)}catch(m){console.error("Error parsing WebSocket message:",m)}},this.ws.onerror=c=>{console.error("WebSocket error:",c),this.notifyListeners("error",{error:c})},this.ws.onclose=()=>{if(console.log("WebSocket disconnected"),this.notifyListeners("connection",{status:"disconnected"}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++,console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);const c=this.reconnectAttempts<=5?3e3:3e4;setTimeout(()=>this.connect(t,r),c)}}}catch(o){console.error("Error connecting to WebSocket:",o)}}buildUrl(t,r={}){if(!r||Object.keys(r).length===0)return t;const o=new URLSearchParams(r);return`${t}?${o.toString()}`}subscribe(t,r){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(r),()=>{this.unsubscribe(t,r)}}unsubscribe(t,r){this.listeners.has(t)&&(this.listeners.get(t).delete(r),this.listeners.get(t).size===0&&this.listeners.delete(t))}notifyListeners(t,r){this.listeners.has(t)&&this.listeners.get(t).forEach(o=>{try{o(r)}catch(c){console.error(`Error in listener callback for ${t}:`,c)}})}send(t,r={}){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const o=JSON.stringify({type:t,data:r});this.ws.send(o)}else console.warn("WebSocket is not connected. Cannot send message.")}disconnect(){this.isIntentionallyClosed=!0,this.ws&&(this.ws.close(),this.ws=null),this.listeners.clear(),this.reconnectAttempts=0}isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}}const R=new me,ue=(b=null,t={})=>{const[r,o]=a.useState(!1),[c,m]=a.useState([]),[v,I]=a.useState(!0),[P,x]=a.useState(!1),p=a.useRef([]),h=a.useRef(null),l=a.useRef(null);return a.useEffect(()=>{I(typeof WebSocket<"u"),b&&typeof WebSocket<"u"&&R.connect(b,t);const u=R.subscribe("connection",y=>{const d=y.status==="connected";o(d),d?(h.current=null,x(!1),l.current&&(clearTimeout(l.current),l.current=null)):!d&&h.current===null&&(h.current=Date.now(),l.current=setTimeout(()=>{x(!0)},6e4))});return p.current.push(u),()=>{p.current.forEach(y=>y()),p.current=[],l.current&&(clearTimeout(l.current),l.current=null)}},[b,t.token]),{isConnected:r,isSupported:v,connectionTimeout:P,messages:c,subscribe:(u,y)=>{const d=R.subscribe(u,y);return p.current.push(d),d},send:(u,y)=>{R.send(u,y)},disconnect:()=>{R.disconnect(),o(!1)}}},Z=[{name:"PayPal",imageOnly:!1,icon:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-8 h-8 text-blue-600",children:e.jsx("path",{d:"M7.5 4.5c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h3.375l-.375 1.5H7.5c-.621 0-1.125.504-1.125 1.125S6.879 21 7.5 21h2.25l1.5-6h2.625c3.75 0 6-1.875 6-5.625 0-2.25-1.125-4.5-4.5-4.5H7.5zm0 1.5h7.125c2.25 0 3 .75 3 2.625 0 2.25-1.125 3-3.75 3H10.5l-.75 3H9l1.125-4.5H7.5c-.621 0-1.125-.504-1.125-1.125V5.625c0-.621.504-1.125 1.125-1.125z"})})},{name:"Stripe",imageOnly:!1,icon:e.jsx("div",{className:"w-8 h-8 bg-purple-600 rounded text-white flex items-center justify-center font-bold text-sm",children:"S"})},{name:"Razorpay",imageOnly:!1,icon:e.jsx("div",{className:"w-8 h-8 bg-blue-800 rounded text-white flex items-center justify-center font-bold text-sm",children:"R"})},{name:"Paytm",imageOnly:!1,icon:e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded text-white flex items-center justify-center font-bold text-sm",children:"P"})},{name:"RoyalXpay",imageOnly:!0,imageUrl:"https://royalxpay.com/assets_frontend/images/RoyalXpay-whitewithtransparent.png",icon:e.jsx("div",{className:"bg-gray-800 px-4 pb-2 rounded",children:e.jsx("img",{src:"https://royalxpay.com/assets_frontend/images/RoyalXpay-whitewithtransparent.png",alt:"RoyalXpay",className:"w-full  h-10 object-contain"})})}],he=({gateway:b})=>{const t=Z.find(r=>r.name===b);return t?t.icon:e.jsx(Q,{className:"w-8 h-8 text-primary"})},ve=({label:b,errors:t,register:r,formData:o,isPlayGround:c,onChangeValue:m,disabled:v,readOnly:I,optional:P,component:x,eventDetails:p,competitions:h,participantsList:l,selectedCompetitions:S})=>{console.log("PayNowButton props:",{label:b,errors:t,formData:o,isPlayGround:c,disabled:v,readOnly:I,optional:P,component:x}),console.log("PayNowButton competitions data:",{competitions:h,selectedCompetitions:S,competitionsLength:h?.length,selectedLength:S?.length});const w="paymentCompleted",[N,u]=a.useState(!1),[y,d]=a.useState([]),[g,L]=a.useState(null),[A,T]=a.useState(!1),[D,H]=a.useState(null),O=x?.paymentGateway||"PayPal";x?.secretKey,x?.webhookUrl;const ee=ie(),{isConnected:te,isSupported:C,connectionTimeout:z,subscribe:j}=ue(ee,{queryParams:{userId:o?.userRoleId||l?.[0]?.UserRoleId||"",type:"payment"}});let se=t?.[w],[J,W]=a.useState(se);a.useEffect(()=>{W(t?.[w])},[t?.[w]]),a.useEffect(()=>{if(A&&D){const s=setTimeout(()=>{T(!1),H(null),u(!1)},6e4);return()=>clearTimeout(s)}},[A,D]),a.useEffect(()=>{const s=j("payment:calculation:success",n=>{n.orderId&&(n.orderId===g||!g&&N)&&d(f=>[...f,{type:"calculation",status:"success",message:"Payment calculation completed successfully",timestamp:new Date().toISOString(),data:n}])}),i=j("payment:order:created",n=>{n.orderId&&(!g||n.orderId===g)&&(g||L(n.orderId),d(f=>[...f,{type:"order",status:"created",message:"Payment order created successfully",timestamp:new Date().toISOString(),data:n}]))}),F=j("payment:transaction:created",n=>{n.orderId&&n.orderId===g&&d(f=>[...f,{type:"transaction",status:"created",message:"Payment link generated successfully",timestamp:new Date().toISOString(),data:n}])}),Y=j("payment:transaction:success",n=>{n.orderId&&n.orderId===g&&(d(f=>[...f,{type:"payment",status:"success",message:"Payment completed successfully!",timestamp:new Date().toISOString(),data:n}]),m&&m(w,!0),u(!1),$.success("Payment completed successfully!"))}),_=j("payment:transaction:failed",n=>{n.orderId&&n.orderId===g&&(d(f=>[...f,{type:"payment",status:"failed",message:n.message||"Payment failed",timestamp:new Date().toISOString(),data:n}]),u(!1),$.error(n.message||"Payment failed. Please try again."))});return()=>{s(),i(),F(),Y(),_()}},[j,g,m,w,N]);const re=()=>{try{let s=h?.filter(U=>S?.includes(U.CompetitionStructureId))||[],i={};try{i=JSON.parse(p?.JsonSettings||"{}")}catch(U){console.warn("Failed to parse event JSON settings:",U)}let F={...o},{products:Y,subTotal:_,discountPrice:n,extraPayments:f,total:oe,feesCurrency:ae,discounts:fe,orders:be}=le(i,s,F);return{gateway:O,userRoleId:o?.userRoleId||l?.[0]?.UserRoleId||null,teamId:o?.teamId||l?.[0]?.TeamId||null,displayedAmount:oe||0,currency:ae||"USD",eventId:p?.EVId||null,registrationId:l?.[0]?.RegistrationId||null,description:`${p?.EventName||"Event"} Registration`,returnUrl:`${window.location.origin}/payment/return`,cancelUrl:`${window.location.origin}/payment/cancel`,timeoutUrl:`${window.location.origin}/payment/timeout`}}catch(s){throw console.error("Error creating order data:",s),new Error("Failed to prepare order data")}},ne=async()=>{if(!(v||I)){u(!0);try{const s=re();if(console.log("Creating order with payload:",s),!s.displayedAmount||s.displayedAmount<=0)throw new Error("Invalid payment amount");if(!s.userRoleId)throw new Error("User role ID is required for secure payment processing");const{data:i}=await ce("/PaymentJson/CreateOrder",s);if(i.Success)if(L(i.orderId||i.OrderNo),W(""),i.PaymentLink)T(!0),H(new Date),setTimeout(()=>{window.open(i.PaymentLink,"_blank")},500);else throw new Error("Invalid payment response - missing payment URL or order ID");else throw new Error(i.message||"Failed to create order, please try again or contact support.")}catch(s){console.error("Payment failed:",s),u(!1);const i=s.message||"Payment failed. Please try again.";W(i),$.error(i)}}},E=o?.[w]===!0,M=h&&Array.isArray(h)&&h.length>0,B=S&&Array.isArray(S)&&S.length>0,X=M&&B,q=v||I||N||!X&&!c||!C||z,G=Z.find(s=>s.name===O)?.imageOnly||!1;return e.jsxs("div",{className:"sm:col-span-4 mb-4",children:[e.jsxs("div",{className:"block text-sm font-semibold leading-6 text-gray-900 mb-2",children:[b||"Payment Gateway",!P&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx("input",{type:"checkbox",...r(w,{required:!P}),checked:E,onChange:()=>{},className:"hidden"}),e.jsx("div",{className:"mb-4 p-4 border border-gray-300 rounded-lg bg-gray-50",children:e.jsxs("div",{className:`flex items-center mb-2 ${G?"justify-center":""}`,children:[e.jsx(he,{gateway:O}),!G&&e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:O})]})}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{type:"button",onClick:ne,disabled:q,className:V("inline-flex items-center justify-center gap-x-2 rounded-md px-6 py-2.5 text-sm font-semibold shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",E?"bg-green-600 text-white hover:bg-green-700 focus-visible:outline-green-600":q?"bg-gray-200 text-gray-700 cursor-not-allowed":"bg-primary text-white hover:bg-primaryHover focus-visible:outline-primary"),children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Creating Order..."]}):E?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-5 w-5"}),"Payment Initiated"]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-5 w-5"}),"Pay Now",te&&e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse",title:"Real-time updates active"})]})}),E&&e.jsxs("div",{className:"text-sm text-green-600 bg-green-50 p-2 rounded border border-green-200",children:[e.jsx(K,{className:"h-4 w-4 inline mr-1"}),"Order has been created and payment initiated."]}),A&&e.jsxs("div",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded border border-amber-200",children:[e.jsx(k,{className:"h-4 w-4 inline mr-1"}),"You have opened a payment gateway link in a new window. Please complete the transaction and come back. This button will be available again in 1 minute."]}),!X&&!c&&e.jsxs("div",{className:"text-sm text-amber-600 bg-amber-50 p-2 rounded border border-amber-200",children:[e.jsx(k,{className:"h-4 w-4 inline mr-1"}),M?B?"No valid competitions for payment.":"No competitions selected for payment. Please select competitions first.":"No competitions available."]}),N&&y.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700 mb-2",children:"Payment Progress:"}),y.map((s,i)=>e.jsxs("div",{className:V("text-sm p-2 rounded border flex items-start gap-2",s.status==="success"?"bg-green-50 border-green-200 text-green-700":s.status==="created"?"bg-blue-50 border-blue-200 text-blue-700":s.status==="failed"?"bg-red-50 border-red-200 text-red-700":"bg-gray-50 border-gray-200 text-gray-700"),children:[s.status==="success"&&e.jsx("div",{className:"h-4 w-4 flex-shrink-0 mt-0.5",children:e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"})}),s.status==="failed"&&e.jsx(k,{className:"h-4 w-4 flex-shrink-0 mt-0.5"}),s.status==="created"&&e.jsx("div",{className:"h-4 w-4 flex-shrink-0 mt-0.5",children:e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:s.message}),s.data?.details&&e.jsx("div",{className:"text-xs mt-1 opacity-75",children:s.data.details})]})]},i))]}),!C&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-50 p-2 rounded border border-red-200",children:[e.jsx(k,{className:"h-4 w-4 inline mr-1"}),"Your browser does not support real-time updates required for secure payments. Please update your browser or use a modern browser like Chrome, Firefox, or Edge."]}),z&&C&&e.jsxs("div",{className:"text-sm text-red-600 bg-red-50 p-2 rounded border border-red-200",children:[e.jsx(k,{className:"h-4 w-4 inline mr-1"}),"We can't connect to our secure payment system due to technical issues. Please try again after some time. Your data is safe and will be preserved."]}),J&&e.jsx(de,{message:J})]})]})};export{ve as default};
